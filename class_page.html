<!DOCTYPE html>
<html lang="id" data-app="academate">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Academate • Kelas</title>
  <!-- Fonts & Icons (same as dashboard master) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css">

  <style>
    /* ===== THEME — identical to dashboard ===== */
    :root{
      --bg:#F7F7FA; --surface:#FFFFFF; --text:#1E1F24; --muted:#6C6F7F;
      --primary:#6F6CFF; --primary-2:#8B7CFF; --border:#ECECF1;
      --shadow:0 6px 24px rgba(30,31,36,.07);
      --radius:18px; --sidebar-w:280px; --gap:18px; --content-max:1320px;
      --bubble:#F6F6FF; --bubble-me:#6F6CFF; --bubble-me-text:#fff;
      --ok:#10B981; --warn:#F59E0B; --danger:#EF4444;
    }
    html,body{height:100%}
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      background:var(--bg); color:var(--text); overflow:hidden; font-size:15px;
    }

    /* App shell */
    .app{padding:var(--gap); width:100%; max-width:1700px; margin:0 auto; height:100dvh; display:grid; grid-template-rows:1fr}
    @media (min-width:901px){
      .app{grid-template-columns:var(--sidebar-w) 1fr; grid-template-rows:1fr; column-gap:24px}
    }

    /* Sidebar (desktop) */
    .sidebar{display:none}
    @media (min-width:901px){
      .sidebar{display:flex; flex-direction:column; background:var(--surface); border-radius:var(--radius); box-shadow:var(--shadow); padding:24px; height:100%; min-height:0}
      .brand{display:flex; align-items:center; gap:12px; font-weight:700; font-size:22px; margin-bottom:18px}
      .brand .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#8B7CFF,#6AC9FF)}
      .nav{display:flex; flex-direction:column; gap:8px; overflow:auto; padding-right:4px}
      .nav a{display:flex; align-items:center; gap:12px; padding:12px 14px; border-radius:12px; color:var(--muted); text-decoration:none; font-weight:500; transition:.2s}
      .nav a i{font-size:20px}
      .nav a:hover{background:#F3F2FF; color:var(--primary)}
      .nav a.active{background:var(--primary); color:#fff; box-shadow:0 8px 20px rgba(111,108,255,.25)}
      .logout{margin-top:auto}
    }

    /* Main layout: FIXED expanded content (no layout jump) */
    .main{display:grid; grid-template-rows:auto 1fr; background:var(--surface); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; height:100%; min-height:0}
    .header{display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid var(--border)}
    .header-left{display:flex; align-items:center; gap:12px}
    .header-title{margin:0; font-size:20px}
    .header-sub{margin:0; color:var(--muted); font-size:13px}
    .header-right{display:flex; align-items:center; gap:10px}
    .icon-btn{width:38px;height:38px;border-radius:50%;border:1px solid var(--border);background:var(--surface);display:grid;place-items:center;cursor:pointer;color:var(--muted);font-size:18px;transition:.2s}
    .icon-btn:hover{color:var(--primary); border-color:#d8d8e0}
    .avatar{width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid var(--border)}

    /* CONTENT: fixed grid that fills remaining height */
    .content{display:grid; grid-template-columns:1fr; gap:18px; padding:18px; height:100%; min-height:0}
    @media (min-width:1100px){ .content{grid-template-columns:2fr 1fr} }

    .card{background:var(--surface); border:1px solid var(--border); border-radius:14px; box-shadow:0 2px 8px rgba(20,20,30,.03); display:flex; flex-direction:column; min-height:0}
    .card-body{padding:16px; display:flex; flex-direction:column; min-height:0; flex-grow: 1;}
    .card-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px}
    .card-title{font-size:16px; font-weight:600; margin:0}
    .btn{display:inline-flex; align-items:center; gap:8px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text); padding:8px 12px; cursor:pointer; font-weight:600; text-decoration:none}
    .btn.primary{background:#F1EEFF; color:var(--primary); border-color:#E3E0FF}
    .btn.full{width:100%; justify-content:center}

    /* === GROUP DISCUSSION — revamped alignment & scaling === */
    .chat-wrapper{display:grid; grid-template-rows:1fr auto; gap:12px; min-height:0; flex:1}
    .feed{position:relative; overflow:auto; padding:8px 12px 8px 0; min-height:0}
    .day-divider{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; margin:10px 0}
    .day-divider::before,.day-divider::after{content:""; height:1px; background:var(--border); flex:1}

    .m{display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:end; margin:8px 0}
    .m.me{grid-template-columns:1fr auto}
    .m.me .ava{order:2}
    .m.me .bubble{order:1; justify-self:end; background:var(--bubble-me); color:var(--bubble-me-text)}
    .ava{width:34px;height:34px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.05)}
    .bubble{max-width:min(640px, 85%); background:var(--bubble); border:1px solid var(--border); padding:10px 12px; border-radius:14px; box-shadow:0 1px 3px rgba(0,0,0,.04); line-height:1.55}
    .meta{display:flex; align-items:center; gap:8px; font-size:11px; color:var(--muted); margin-top:6px}
    .m.me .meta { color: rgba(255, 255, 255, 0.75); }
    .sender{font-weight:600; font-size:12px}
    .msg-img{border-radius:12px; border:1px solid var(--border); max-width:260px; width:100%; height:auto}

    /* Composer: sticky, auto-grow textarea, attach & emoji */
    .composer{display:flex; align-items:flex-end; gap:10px; background:var(--surface); border-top:1px solid var(--border); padding-top:10px}
    .composer .tools{display:flex; align-items:center; gap:6px}
    /* TWEAK 3: Align composer items */
    .i-btn{width:44px;height:44px;border-radius:10px;border:1px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted);font-size:18px}
    .composer textarea{flex:1; resize:none; max-height:34dvh; min-height:44px; padding:12px 14px; border:1px solid var(--border); border-radius:12px; font:inherit; line-height:1.5; overflow:auto;}
    .composer button{height:44px; padding:12px 14px; border:none; border-radius:12px; background:var(--primary); color:#fff; font-weight:700; cursor:pointer}
    .typing{font-size:12px; color:var(--muted); margin-top:4px}

    /* Better list sections */
    .tasks{list-style:none; padding:0; margin:0; display:flex; flex-direction:column; overflow:auto}
    .task{border-top:1px solid var(--border)}
    .task:first-child{border-top:0}
    .task-h{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 0; cursor:pointer}
    .task-left{display:flex; align-items:center; gap:12px; min-width:0}
    .checkbox{width:20px;height:20px;border-radius:6px;border:2px solid var(--border);display:grid;place-items:center;flex-shrink:0;background:#fff}
    .task.done .checkbox{background:var(--primary); border-color:var(--primary)}
    .checkbox i{font-size:14px; color:#fff; opacity:0; transform:scale(.6); transition:.15s}
    .task.done .checkbox i{opacity:1; transform:scale(1)}
    .task-title{font-weight:600; white-space:nowrap; text-overflow:ellipsis; overflow:hidden}
    .due{font-size:11px; padding:4px 8px; border-radius:99px; flex-shrink:0}
    .due.normal{background:#F5F6FA; color:var(--muted)}
    .due.soon{background:#FEF3C7; color:#B45309}
    .due.urgent,.due.overdue{background:#FEE2E2; color:#B91C1C}
    .expand i{color:var(--muted)}
    .task-details{max-height:0; overflow:hidden; transition:max-height .3s ease, padding .3s ease}
    .task.expanded .task-details{max-height:600px; padding-bottom:12px}
    .task-desc{margin:0 0 10px 32px; color:#3a3d4a; line-height:1.6; white-space:pre-wrap}
    .task-foot{display:flex; justify-content:space-between; align-items:center; gap:10px; padding-left:32px}
    .task-foot .who{font-size:12px; color:var(--muted)}
    .task-foot .del{border:none; background:transparent; color:var(--muted); cursor:pointer; padding:6px 8px; border-radius:8px}
    .task-foot .del:hover{background:#FEE2E2; color:#B91C1C}
    .pp-row{display:flex}
    .pp-row img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:2px solid #fff;margin-left:-8px}
    .pp-row img:first-child{margin-left:0}

    /* Notes */
    .notes{list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; overflow:auto}
    .note{border:1px solid var(--border); background:#FAFAFF; border-radius:12px; padding:12px; cursor:pointer; transition:.2s}
    .note:hover{background:#F3F2FF; border-color:#DCD9FF}
    .note h4{margin:0 0 4px; font-size:14px}
    .note p{margin:0; color:#3a3d4a; font-size:13px}
    .note small{display:block; color:var(--muted); margin-top:8px}
    
    /* ===== MODERN SCROLLBAR (REVISED) ===== */
    .nav, .feed, #read-note-body {
      scrollbar-width: thin; scrollbar-color: var(--primary-2) transparent;
    }
    .nav::-webkit-scrollbar, .feed::-webkit-scrollbar, #read-note-body::-webkit-scrollbar { width: 8px; }
    .nav::-webkit-scrollbar-track, .feed::-webkit-scrollbar-track, #read-note-body::-webkit-scrollbar-track { background: transparent; }
    .nav::-webkit-scrollbar-thumb, .feed::-webkit-scrollbar-thumb, #read-note-body::-webkit-scrollbar-thumb { background-color: var(--primary-2); border-radius: 20px; }
    .nav::-webkit-scrollbar-thumb:hover, .feed::-webkit-scrollbar-thumb:hover, #read-note-body::-webkit-scrollbar-thumb:hover { background-color: var(--primary); }
    .tasks, .notes, .composer textarea { -ms-overflow-style: none; scrollbar-width: none; }
    .tasks::-webkit-scrollbar, .notes::-webkit-scrollbar, .composer textarea::-webkit-scrollbar { display: none; }
    body { scrollbar-width: thin; scrollbar-color: var(--primary-2) var(--bg); }
    body::-webkit-scrollbar { width: 8px; }
    body::-webkit-scrollbar-track { background: var(--bg); }
    body::-webkit-scrollbar-thumb { background: var(--primary-2); border-radius: 20px; }
    body::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    /* ===== FIX 1: Decouple side panel to fix desktop layout ===== */
    .side-panel {
      display: flex; flex-direction: column; gap: var(--gap); min-height: 0;
    }

    /* Mobile bottom nav */
    .mnav{position:fixed; left:0; right:0; bottom:0; height:70px; background:rgba(255,255,255,.85); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border-top:1px solid var(--border); display:flex; justify-content:space-around; align-items:center; z-index:40}
    .mnav a{display:flex; flex-direction:column; align-items:center; gap:4px; text-decoration:none; color:var(--muted); font-size:10px; font-weight:600}
    .mnav a i{font-size:20px}
    .mnav a.active{color:var(--primary)}
    @media (min-width:901px){ .mnav{display:none} }

    /* Utilities */
    .skeleton{background:linear-gradient(90deg,#f2f2f6 25%,#fafafd 37%,#f2f2f6 63%); background-size:400% 100%; animation:shimmer 1.2s ease infinite; border-radius:12px}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    .loader{border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:24px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .empty{color:var(--muted); text-align:center; padding:18px}

    /* ===== MOBILE RESPONSIVENESS ===== */
    @media (max-width: 900px) {
      body { overflow: auto; }
      .app { display: block; height: auto; padding-bottom: 88px; }
      .main { display: block; height: auto; }
      .content { display: flex; flex-direction: column; height: auto; gap: var(--gap); }
      .card-body { flex-grow: 0; }
      #discussion-card { height: 75dvh; display: flex; flex-direction: column; }
      #discussion-card .card-body { flex-grow: 1; }
    }
    @media (max-width: 450px) {
      .content { padding: 12px; gap: 12px; }
      .card-body { padding: 12px; }
      .m { gap: 8px; }
      .ava { width: 32px; height: 32px; }
      .bubble { padding: 8px 12px; font-size: 14px; }
      .sender { font-size: 11px; }
      .composer { gap: 6px; padding-top: 8px; }
      .i-btn { width: 42px; height: 42px; } /* Adjust for mobile */
      .composer textarea { min-height: 42px; font-size: 14px; padding: 10px 12px; }
      #send-btn { width: 42px; height: 42px; padding: 0; font-size: 0; display: grid; place-items: center; flex-shrink: 0; }
      #send-btn i { font-size: 20px; margin: 0; }
    }

    /* ===== MODALS (NEWLY ADDED & FIXED) ===== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(30, 31, 36, 0.6);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      animation: fade-in 0.2s ease;
    }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    
    .modal {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      width: min(95vw, 480px);
      max-height: 90vh;
      overflow-y: auto;
      animation: modal-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .modal h2 { margin: 0 0 16px; }
    @keyframes modal-pop {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .m-form { display: flex; flex-direction: column; gap: 14px; }
    .m-form label { font-weight: 600; font-size: 14px; color: var(--text); }
    .m-form input, .m-form textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font: inherit;
      background: var(--bg);
      transition: border-color .2s, box-shadow .2s;
    }
    .m-form input:focus, .m-form textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px #6f6cff3b;
    }
    
    .m-foot { display: flex; justify-content: flex-end; gap: 10px; margin-top: 16px; }
    .m-btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid transparent;
      font-weight: 600;
      cursor: pointer;
      transition: .2s;
    }
    .m-btn.primary { background: var(--primary); color: #fff; }
    .m-btn.primary:hover { background: var(--primary-2); }
    .m-btn.ghost { border-color: var(--border); background: transparent; color: var(--muted); }
    .m-btn.ghost:hover { background: var(--bg); color: var(--text); }
  </style>
</head>
<body data-page="classes">
  <div class="app">
    <!-- Sidebar (desktop) -->
    <aside class="sidebar">
      <div class="brand"><div class="logo"></div> Academate</div>
      <nav class="nav">
        <a href="dashboard.html"><i class="ri-layout-grid-line"></i><span>Dasbor</span></a>
        <a href="classes.html" class="active"><i class="ri-book-2-line"></i><span>Kelas</span></a>
        <a href="schedule.html"><i class="ri-calendar-line"></i><span>Jadwal</span></a>
        <a href="notes.html"><i class="ri-file-text-line"></i><span>Catatan</span></a>
        <a href="account.html" class="logout"><i class="ri-user-3-line"></i><span>Akun</span></a>
      </nav>
    </aside>

    <!-- Main (fixed grid rows: header + content that fills) -->
    <section class="main" id="main">
      <!-- Top header -->
      <div class="header">
        <div class="header-left">
          <button class="icon-btn" id="back-btn" title="Kembali" aria-label="Kembali"><i class="ri-arrow-left-line"></i></button>
          <div>
            <h2 class="header-title" id="class-title">Memuat Kelas…</h2>
            <p class="header-sub" id="class-sub">—</p>
          </div>
        </div>
        <div class="header-right">
          <button class="icon-btn" id="refresh-btn" title="Segarkan" aria-label="Segarkan"><i class="ri-refresh-line"></i></button>
          <img id="avatar-top" class="avatar" src="https://placehold.co/80x80" alt="Profile"/>
        </div>
      </div>

      <!-- FIXED Content area (always expanded) -->
      <div class="content" id="content" role="main" aria-live="polite">
        <!-- LEFT: Discussion (fills column height) -->
        <div class="card" id="discussion-card">
          <div class="card-body">
            <div class="card-head">
              <h3 class="card-title">Diskusi Kelas</h3>
              <div style="display:flex; gap:8px; align-items:center">
                <span id="presence" class="header-sub">— online</span>
                <button class="btn" id="jump-latest"><i class="ri-arrow-down-line"></i> Terbaru</button>
              </div>
            </div>

            <div class="chat-wrapper">
              <div id="discussion-feed" class="feed" aria-label="Utas diskusi">
                <div class="loader"></div>
              </div>

              <div class="composer">
                <div class="tools">
                  <!-- TWEAK 1: Use SVG icons for a lighter look -->
                  <button class="i-btn" id="attach-btn" title="Lampirkan" aria-label="Lampirkan">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                  </button>
                  <button class="i-btn" id="emoji-btn" title="Emoji" aria-label="Emoji">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                  </button>
                  <input id="file-input" type="file" accept="image/*" hidden>
                </div>
                <textarea id="discussion-input" placeholder="Ketik pesan… Gunakan @ untuk menyebut teman" rows="1"></textarea>
                <button id="send-btn" class="btn primary"><i class="ri-send-plane-2-line"></i> Kirim</button>
              </div>
            </div>
            <div id="typing" class="typing" aria-live="polite" hidden>Beberapa orang sedang mengetik…</div>
          </div>
        </div>

        <!-- RIGHT: Tasks + Notes (columns scroll independently) -->
        <div class="side-panel">
          <div class="card">
            <div class="card-body" style="min-height:0">
              <div class="card-head"><h3 class="card-title">Tugas</h3></div>
              <ul id="task-list" class="tasks" aria-label="Daftar tugas">
                <div class="loader"></div>
              </ul>
              <button id="add-task-btn" class="btn primary full"><i class="ri-add-line"></i> Tambah Tugas Baru</button>
            </div>
          </div>

          <div class="card">
            <div class="card-body" style="min-height:0">
              <div class="card-head">
                <h3 class="card-title">Catatan Bersama</h3>
                <!-- TWEAK 2: Change button to 'Tambah' -->
                <button id="add-note-btn" class="btn primary"><i class="ri-add-line"></i> Tambah</button>
              </div>
              <ul id="shared-notes-list" class="notes" aria-label="Catatan bersama">
                <div class="loader"></div>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Mobile bottom nav -->
  <nav class="mnav">
    <a href="dashboard.html"><i class="ri-layout-grid-line"></i><span>Dasbor</span></a>
    <a href="classes.html" class="active"><i class="ri-book-2-line"></i><span>Kelas</span></a>
    <a href="schedule.html"><i class="ri-calendar-line"></i><span>Jadwal</span></a>
    <a href="notes.html"><i class="ri-file-text-line"></i><span>Catatan</span></a>
    <a href="account.html"><i class="ri-user-3-line"></i><span>Akun</span></a>
  </nav>

  <!-- Add Task Modal -->
  <div class="overlay" id="add-task-modal" style="display:none">
    <div class="modal">
      <h2>Tambah Tugas Baru</h2>
      <form id="add-task-form" class="m-form">
        <div>
          <label for="task-title-input">Judul Tugas</label>
          <input type="text" id="task-title-input" required />
        </div>
        <div>
          <label for="task-due-date-input">Tenggat Waktu</label>
          <input type="date" id="task-due-date-input" required />
        </div>
        <div>
          <label for="task-description-input">Deskripsi (Opsional)</label>
          <textarea id="task-description-input" rows="4" placeholder="Detail tugas…"></textarea>
        </div>
        <div class="m-foot">
          <button type="button" class="m-btn ghost" id="cancel-add-task-btn">Batal</button>
          <button type="submit" class="m-btn primary" id="confirm-add-task-btn">Tambah</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Read Note Modal -->
  <div class="overlay" id="read-note-modal" style="display:none">
    <div class="modal" style="width:min(92vw,680px)">
      <h2 id="read-note-title">—</h2>
      <div id="read-note-meta" style="color:var(--muted); border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:14px"></div>
      <div id="read-note-body" style="max-height:60vh; overflow:auto; line-height:1.7; color:#3a3d4a"></div>
      <div class="m-foot">
        <button class="m-btn primary" id="read-note-close-btn">Tutup</button>
      </div>
    </div>
  </div>

  <!-- ===== PAGE SCRIPT ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, onSnapshot, Timestamp, arrayUnion, arrayRemove, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGr2zchpiAiTn-bMFk-eLNE-1OgGzaSdA",
      authDomain: "acadmte.firebaseapp.com",
      projectId: "acadmte",
      storageBucket: "acadmte.appspot.com",
      messagingSenderId: "547286858993",
      appId: "1:547286858993:web:b83de49e7eb1cc35a67d50",
      measurementId: "G-ZEFYD7F650"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null, classId = null, membersCache = {}, classMemberCount = 0;
    let discussionUnsub = null, tasksUnsub = null, notesUnsub = null;

    const $ = (id)=>document.getElementById(id);

    window.addEventListener('resize', fixVH); fixVH();
    function fixVH(){ document.documentElement.style.setProperty('--vh', window.innerHeight + 'px'); }

    // TWEAK 3: Function to dynamically change placeholder text based on screen size
    function updatePlaceholder() {
      const input = $('discussion-input');
      if (!input) return;
      if (window.innerWidth <= 600) { // Mobile breakpoint
        input.placeholder = "Ketik pesan…";
      } else {
        input.placeholder = "Ketik pesan… Gunakan @ untuk menyebut teman";
      }
    }
    window.addEventListener('resize', updatePlaceholder); // Update on resize

    onAuthStateChanged(auth, async (user) => {
      if (!user) { cleanup(); window.location.replace('auth.html'); return; }
      currentUser = user;
      $('avatar-top').src = user.photoURL || 'https://placehold.co/80x80';
      const params = new URLSearchParams(location.search); classId = params.get('id');
      if (!classId) { renderEmpty('ID Kelas tidak ditemukan.'); return; }

      updatePlaceholder(); // Set initial placeholder on load
      
      await loadClass();
    });

    function cleanup(){ [discussionUnsub,tasksUnsub,notesUnsub].forEach(u=>u && u()); }
    $('back-btn').addEventListener('click', ()=> history.length>1?history.back():location.assign('classes.html'));
    $('refresh-btn').addEventListener('click', ()=> location.reload());

    async function loadClass(){
      try{
        const classSnap = await getDoc(doc(db,'classes',classId));
        if (!classSnap.exists()){ renderEmpty('Kelas tidak ditemukan.'); return; }
        const data = classSnap.data();
        const userDoc = await getDoc(doc(db,'users',currentUser.uid));
        if (!(userDoc.data()?.joinedClasses||[]).includes(classId)){ renderEmpty('Anda tidak memiliki akses ke kelas ini.'); return; }

        await cacheMembers(data.members || []);

        $('class-title').textContent = data.namaMataKuliah;
        $('class-sub').textContent = `${data.dosen} • ${data.hari}, ${data.waktu} - ${data.waktuSelesai || ''}`;

        listenDiscussions();
        listenTasks();
        listenNotes();
      }catch(e){ console.error(e); renderEmpty('Gagal memuat halaman kelas.'); }
    }

    async function cacheMembers(ids){
      classMemberCount = ids.length;
      const snaps = await Promise.all(ids.map(id => getDoc(doc(db,'users',id))));
      membersCache = snaps.reduce((m,s)=> (s.exists() && (m[s.id]=s.data()), m), {});
    }

    let latestDoc = null; let fetchingMore = false;

    function listenDiscussions(){
      const qRef = query(collection(db,'classes',classId,'discussions'), orderBy('createdAt','desc'), limit(30));
      discussionUnsub = onSnapshot(qRef, (snap)=>{
        const feed = $('discussion-feed'); if (!feed) return;
        feed.innerHTML = '';
        let lastDay = '';
        latestDoc = snap.docs[snap.docs.length - 1] || null;
        const docs = snap.docs.slice().reverse();
        docs.forEach(d => {
          const m = d.data();
          const created = m.createdAt?.toDate?.() || new Date();
          const dayKey = created.toDateString();
          if (dayKey !== lastDay){
            feed.appendChild(el('div',{class:'day-divider'}, created.toLocaleDateString('id-ID',{weekday:'long',year:'numeric',month:'long',day:'numeric'})));
            lastDay = dayKey;
          }
          feed.appendChild(renderMsg(m));
        });
        if (!fetchingMore) {
          requestAnimationFrame(()=> feed.scrollTop = feed.scrollHeight);
        }
      });

      $('discussion-feed').addEventListener('scroll', async (e)=>{
        const elFeed = e.currentTarget; if (elFeed.scrollTop > 40 || fetchingMore || !latestDoc) return;
        fetchingMore = true;
        const qMore = query(collection(db,'classes',classId,'discussions'), orderBy('createdAt','desc'), startAfter(latestDoc), limit(30));
        const more = await (await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js')).getDocs(qMore);
        if (!more.empty){ latestDoc = more.docs[more.docs.length-1]; prependMessages(elFeed, more.docs.reverse().map(d=>d.data())); }
        fetchingMore = false;
      });

      $('jump-latest').addEventListener('click', ()=> {
        const feed = $('discussion-feed'); feed.scrollTop = feed.scrollHeight;
      });

      let typingTimer;
      $('discussion-input').addEventListener('input', ()=>{
        $('typing').hidden = false;
        clearTimeout(typingTimer);
        typingTimer = setTimeout(()=> $('typing').hidden = true, 1200);
      });

      const ta = $('discussion-input');
      function autoGrow(){ ta.style.height = 'auto'; ta.style.height = Math.min(ta.scrollHeight, window.innerHeight*0.34) + 'px'; }
      ['input','focus'].forEach(evt=> ta.addEventListener(evt, autoGrow));

      $('emoji-btn').addEventListener('click', ()=> insertAtCursor(ta,'🙂'));
      $('attach-btn').addEventListener('click', ()=> $('file-input').click());
      $('file-input').addEventListener('change', (e)=>{
        const file = e.target.files?.[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = ()=> addMessage(undefined, reader.result);
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      $('send-btn').addEventListener('click', ()=> addMessage());
      $('discussion-input').addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); addMessage(); }
      });
    }

    function renderMsg(m){
      const isMe = m.senderId === currentUser?.uid;
      const wrap = el('div',{class:'m'+(isMe?' me':'')});
      const ava = el('img',{class:'ava',src: m.senderPhotoURL || 'https://placehold.co/80x80', alt: m.senderName || 'avatar'});
      const bubble = el('div',{class:'bubble'});
      const sender = el('div',{class:'sender'}, m.senderName || 'Anonymous');
      const msgContent = m.text ? m.text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : (m.image ? `<img class="msg-img" src="${m.image}" alt="lampiran">` : '');
      const msg = el('div',{}, msgContent);
      const time = m.createdAt?.toDate?.() || new Date();
      const meta = el('div',{class:'meta'}, time.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}));
      bubble.append(sender,msg,meta);
      if (isMe){ wrap.append(bubble, ava); } else { wrap.append(ava, bubble); }
      return wrap;
    }

    function prependMessages(feed, arr){
      const top = feed.scrollHeight - feed.scrollTop;
      arr.forEach(m => feed.insertBefore(renderMsg(m), feed.firstChild));
      requestAnimationFrame(()=> feed.scrollTop = feed.scrollHeight - top);
    }

    async function addMessage(_, imageData){
      const ta = $('discussion-input');
      const text = (ta.value||'').trim();
      if (!text && !imageData) return;
      ta.disabled = true; $('send-btn').disabled = true;
      try{
        await addDoc(collection(db,'classes',classId,'discussions'),{
          text: text || null,
          image: imageData || null,
          senderId: currentUser.uid,
          senderName: currentUser.displayName || 'Anonymous',
          senderPhotoURL: currentUser.photoURL || null,
          createdAt: serverTimestamp()
        });
        ta.value=''; autoGrow();
      }catch(e){ console.error(e); alert('Gagal mengirim pesan.'); }
      finally{ ta.disabled=false; $('send-btn').disabled=false; ta.focus(); }
    }

    function insertAtCursor(elm, txt){
      const start = elm.selectionStart, end = elm.selectionEnd;
      const before = elm.value.substring(0,start), after = elm.value.substring(end);
      elm.value = before + txt + after; elm.selectionStart = elm.selectionEnd = start + txt.length; elm.dispatchEvent(new Event('input')); elm.focus();
    }

    // ---- Tasks (FIXED & REFACTORED) ----
    function listenTasks(){
      const qRef = query(collection(db,'classes',classId,'tasks'), orderBy('dueDate','asc'));
      tasksUnsub = onSnapshot(qRef,(snap)=>{
        const ul = $('task-list'); ul.innerHTML='';
        if (snap.empty){ ul.innerHTML = '<div class="empty">Tidak ada tugas.</div>'; return; }
        snap.forEach(d=> renderTask(d.id, d.data(), ul));
      });
      
      // Listener for the static "Add Task" button
      $('add-task-btn').addEventListener('click', () => {
        $('add-task-modal').style.display = 'flex';
      });

      // Event delegation on the list for dynamic task items (toggle, delete)
      $('task-list').addEventListener('click', (e) => {
        const cb = e.target.closest('.checkbox');
        if (cb) {
          toggleTask(cb.dataset.id);
          return;
        }
        const del = e.target.closest('.del');
        if (del) {
          deleteTask(del.dataset.id);
          return;
        }
      });
      
      // Listeners for the modal buttons
      $('cancel-add-task-btn').addEventListener('click', ()=> $('add-task-modal').style.display='none');
      $('add-task-form').addEventListener('submit', addTask);
    }

    function renderTask(id,t,ul){
      const isDone = t.completedBy?.includes(currentUser.uid);
      const due = formatDue(t.dueDate);
      const isCreator = t.creatorId === currentUser.uid;
      const li = document.createElement('li'); li.className = `task ${isDone?'done':''}`; li.id = `task-${id}`;
      const avatars = (t.completedBy||[]).map(uid=>{
        const u = membersCache[uid]; return u?`<img src="${u.photoURL}" title="${u.displayName || u.name}" alt="${u.displayName || u.name}">`:'';
      }).join('');
      const safeTitle = (t.title || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
      const safeDesc = (t.description || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");

      li.innerHTML = `
        <div class="task-h">
          <div class="task-left">
            <div class="checkbox" data-id="${id}"><i class="ri-check-line"></i></div>
            <div class="task-title">${safeTitle}</div>
          </div>
          <div style="display:flex; align-items:center; gap:10px">
            <span class="due ${due.cls}">${due.text}</span>
            <div class="expand"><i class="ri-arrow-down-s-line"></i></div>
          </div>
        </div>
        <div class="task-details">
          ${t.description ? `<p class="task-desc">${safeDesc.replace(/\n/g,'<br>')}</p>` : ''}
          <div class="task-foot">
            <div>
              <div class="who">${(t.completedBy?.length||0)} dari ${classMemberCount} selesai</div>
              <div class="pp-row">${avatars}</div>
            </div>
            ${isCreator ? `<button class="del" data-id="${id}" aria-label="Hapus tugas"><i class="ri-delete-bin-6-line"></i> Hapus</button>`:''}
          </div>
        </div>`;
      ul.appendChild(li);
      li.querySelector('.task-h').addEventListener('click', (e)=> {
        if(!e.target.closest('.checkbox')) {
            li.classList.toggle('expanded');
        }
      });
    }

    function formatDue(ts){
      const now = new Date(); const due = ts?.toDate?.() || new Date();
      now.setHours(0,0,0,0); due.setHours(0,0,0,0);
      const diff = Math.ceil((due-now)/(1000*60*60*24));
      if (diff < 0) return {text:'Telah lewat', cls:'overdue'};
      if (diff === 0) return {text:'Tenggat hari ini', cls:'urgent'};
      if (diff === 1) return {text:'Tenggat besok', cls:'urgent'};
      if (diff <= 7) return {text:`Tenggat ${diff} hari lagi`, cls:'soon'};
      return {text: due.toLocaleDateString('id-ID',{day:'numeric',month:'short'}), cls:'normal'};
    }

    async function toggleTask(id){
      const ref = doc(db,'classes',classId,'tasks',id);
      const li = $('task-'+id), done = li?.classList.contains('done');
      try{ await updateDoc(ref, done? {completedBy: arrayRemove(currentUser.uid)} : {completedBy: arrayUnion(currentUser.uid)}); }
      catch(e){ console.error(e); alert('Gagal memperbarui status tugas.'); }
    }

    async function addTask(e){
      e.preventDefault();
      const title = $('task-title-input').value.trim();
      const dateStr = $('task-due-date-input').value; const desc = $('task-description-input').value.trim();
      if (!title || !dateStr) return;
      $('confirm-add-task-btn').disabled = true;
      try{
        await addDoc(collection(db,'classes',classId,'tasks'),{
          title, description: desc||null, dueDate: Timestamp.fromDate(new Date(dateStr)),
          createdAt: serverTimestamp(), creatorId: currentUser.uid, creatorName: currentUser.displayName||'—', completedBy: []
        });
        $('add-task-form').reset(); $('add-task-modal').style.display='none';
      }catch(e){ console.error(e); alert('Gagal menambahkan tugas.'); }
      finally{ $('confirm-add-task-btn').disabled=false; }
    }

    async function deleteTask(id){
      // Using a custom modal instead of confirm()
      if (await showConfirm('Hapus tugas ini untuk semua anggota kelas?')) {
        try{ await deleteDoc(doc(db,'classes',classId,'tasks',id)); }
        catch(e){ console.error(e); alert('Gagal menghapus tugas.'); }
      }
    }

    // ---- Shared Notes (FIXED) ----
    function listenNotes(){
      const qRef = query(collection(db,'classes',classId,'sharedNotes'), orderBy('sharedAt','desc'));
      notesUnsub = onSnapshot(qRef,(snap)=>{
        const ul = $('shared-notes-list'); ul.innerHTML='';
        if (snap.empty){ ul.innerHTML = '<div class="empty">Belum ada catatan bersama.</div>'; return; }
        snap.forEach(d=>{
          const n = d.data();
          const li = document.createElement('li'); li.className='note';
          li.dataset.title = n.title; li.dataset.body = n.body; li.dataset.author = n.sharedBy;
          li.dataset.date = n.sharedAt? n.sharedAt.toDate().toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'}) : '';
          const safeTitle = (n.title || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
          const safeBody = (n.body || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
          li.innerHTML = `<h4>${safeTitle}</h4><p>${safeBody.substring(0,120)}${safeBody.length>120?'…':''}</p><small>Oleh ${n.sharedBy}</small>`;
          li.addEventListener('click', ()=> showNote(li.dataset));
          ul.appendChild(li);
        });
      });
      $('add-note-btn').addEventListener('click', (e)=>{ e.preventDefault(); location.href = `notes.html?share_to=${classId}`; });
      $('read-note-close-btn').addEventListener('click', ()=> $('read-note-modal').style.display='none');
    }

    function showNote(data){
      $('read-note-title').textContent = data.title || '—';
      $('read-note-meta').innerHTML = `Dibagikan oleh <strong>${data.author||'—'}</strong> ${data.date?`pada ${data.date}`:''}`;
      $('read-note-body').innerHTML = `<p>${(data.body||'').replace(/\n/g,'<br>')}</p>`;
      $('read-note-modal').style.display='flex';
    }

    // ---- helpers ----
    function renderEmpty(msg){ $('content').innerHTML = `<div class="empty">${msg}</div>`; }
    function el(tag, attrs={}, children){
      const e = document.createElement(tag);
      Object.entries(attrs||{}).forEach(([k,v])=> e.setAttribute(k,v));
      if (children != null) e.innerHTML = children; return e;
    }
    
    // Custom confirm modal helper
    function showConfirm(message) {
      return new Promise(resolve => {
        const confirmOverlay = el('div', { class: 'overlay' });
        const confirmModal = el('div', { class: 'modal' });
        const msgEl = el('p', {}, message);
        const footEl = el('div', { class: 'm-foot' });
        const yesBtn = el('button', { class: 'm-btn primary' }, 'Ya, Hapus');
        const noBtn = el('button', { class: 'm-btn ghost' }, 'Batal');
        
        footEl.append(noBtn, yesBtn);
        confirmModal.append(msgEl, footEl);
        confirmOverlay.append(confirmModal);
        document.body.appendChild(confirmOverlay);

        yesBtn.onclick = () => { resolve(true); confirmOverlay.remove(); };
        noBtn.onclick = () => { resolve(false); confirmOverlay.remove(); };
      });
    }

    // Global actions
    document.querySelector('.logout')?.addEventListener('click', (e)=>{ e.preventDefault(); signOut(auth); });
  </script>
</body>
</html>

