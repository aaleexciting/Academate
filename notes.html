<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan - Academate</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #7C3AED;
            --primary-light: #F5F3FF;
            --text-dark: #111827;
            --text-light: #374151;
            --text-muted: #6B7280;
            --bg-body: #F9FAFB;
            --bg-sidebar: #FFFFFF;
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* --- Sidebar --- */
        .sidebar { width: 260px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 1.5rem; }
        .sidebar-header { font-size: 1.75rem; font-weight: 700; color: var(--primary-color); text-decoration: none; margin-bottom: 2.5rem; padding: 0 0.5rem; }
        .nav-menu { list-style: none; flex-grow: 1; }
        .nav-item a { display: flex; align-items: center; padding: 0.85rem 1rem; text-decoration: none; color: var(--text-light); font-weight: 500; border-radius: 0.5rem; margin-bottom: 0.5rem; transition: background-color 0.2s ease, color 0.2s ease; }
        .nav-item a:hover { background-color: var(--primary-light); color: var(--primary-color); }
        .nav-item a.active { background-color: var(--primary-color); color: #fff; font-weight: 600; }
        .nav-item a svg { width: 20px; height: 20px; margin-right: 1rem; }
        .logout-button { display: flex; align-items: center; padding: 0.85rem 1rem; text-decoration: none; color: var(--text-light); font-weight: 500; border-radius: 0.5rem; background-color: transparent; border: none; width: 100%; font-family: 'Inter', sans-serif; font-size: 1rem; cursor: pointer; }
        .logout-button:hover { background-color: #FEE2E2; color: #EF4444; }

        /* --- Main Content --- */
        .main-content { flex-grow: 1; display: flex; overflow: hidden; }

        /* Notes List Panel */
        .notes-list-panel {
            width: 380px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background-color: #FFFFFF;
        }
        .notes-list-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notes-list-header h1 { font-size: 1.5rem; }
        .new-note-btn { padding: 0.6rem 1rem; background-color: var(--primary-color); color: #fff; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .new-note-btn:hover { background-color: #6D28D9; }
        
        .notes-list-controls { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); }
        .search-bar { display: flex; align-items: center; background-color: var(--bg-body); border-radius: 0.5rem; padding: 0.5rem 0.75rem; margin-bottom: 1rem; }
        .search-bar svg { color: var(--text-muted); margin-right: 0.5rem; }
        .search-bar input { flex-grow: 1; border: none; background: transparent; font-size: 1rem; outline: none; }
        .tabs { display: flex; background-color: var(--bg-body); border-radius: 0.5rem; padding: 0.25rem; }
        .tab-btn { flex: 1; padding: 0.5rem; border: none; background-color: transparent; border-radius: 0.375rem; cursor: pointer; font-weight: 500; color: var(--text-light); transition: all 0.2s ease; }
        .tab-btn.active { background-color: #fff; color: var(--primary-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        #notes-list-container { list-style: none; overflow-y: auto; flex-grow: 1; }
        .note-item, .shared-note-item { padding: 1.25rem 1.5rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .note-item.active, .shared-note-item.active { background-color: var(--primary-light); }
        .note-item h3, .shared-note-item h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.35rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-item .note-excerpt, .shared-note-item .note-excerpt { font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.75rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .note-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-muted); }
        .shared-tag { background-color: #E9D5FF; color: var(--primary-color); font-weight: 500; padding: 0.2rem 0.5rem; border-radius: 99px; }
        .shared-note-meta { display: flex; align-items: center; gap: 0.5rem; }
        .class-color-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .class-name { font-weight: 500; }
        
        /* Note Panel (Editor or Reader) */
        .note-panel { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #editor-placeholder { text-align: center; padding-top: 20vh; color: var(--text-muted); margin: auto; }
        #editor-placeholder svg { width: 80px; height: 80px; margin-bottom: 1rem; }
        
        /* Editor View */
        #editor-container { display: none; flex-direction: column; height: 100%; }
        .editor-header { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .editor-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .save-btn { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .save-btn:hover { background-color: #6D28D9; }
        .save-btn:disabled { background-color: #A78BFA; cursor: not-allowed; }
        .share-btn { background-color: transparent; color: var(--text-light); border: 1px solid var(--border-color); }
        .share-btn:hover { background-color: var(--bg-body); }
        .delete-btn { color: #EF4444; }
        .delete-btn:hover { background-color: #FEE2E2; }
        .title-wrapper { padding: 1rem 2rem 0; }
        #note-title-input { width: 100%; border: none; font-size: 2rem; font-weight: 700; padding: 0.5rem 0; background: transparent; outline: none; }
        #note-meta { color: var(--text-muted); font-size: 0.8rem; padding: 0 2rem 0.5rem; }
        #quill-editor-container { flex-grow: 1; overflow-y: auto; position: relative; }
        #quill-editor { height: 100%; }
        .ql-container.ql-snow { border: none !important; }
        .ql-editor { font-size: 16px; line-height: 1.7; padding: 1.5rem 2rem; }
        .ql-toolbar.ql-snow { border: none !important; border-bottom: 1px solid var(--border-color) !important; padding: 12px 2rem; }
        #word-count { text-align: right; padding: 0.5rem 2rem; font-size: 0.8rem; color: var(--text-muted); border-top: 1px solid var(--border-color); }
        
        /* Reader View for Shared Notes */
        #reader-container { display: none; flex-direction: column; height: 100%; }
        .reader-header { padding: 2rem 3rem; border-bottom: 1px solid var(--border-color); background-color: var(--card-bg); }
        .reader-header h2 { font-size: 2.25rem; font-weight: 700; margin-bottom: 0.75rem; }
        .reader-meta { display: flex; align-items: center; gap: 1rem; color: var(--text-muted); }
        .reader-meta-item { display: flex; align-items: center; gap: 0.5rem; }
        .reader-meta-item svg { width: 16px; height: 16px; }
        .reader-body { flex-grow: 1; overflow-y: auto; padding: 2rem 3rem; font-size: 17px; line-height: 1.8; max-width: 800px; margin: 0 auto; width: 100%; }
        .reader-body p { white-space: pre-wrap; }
        
        /* Modals & Loaders */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: #fff; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; }
        .modal h2 { margin-bottom: 1.5rem; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
        .form-group label { margin-bottom: 0.5rem; font-weight: 500; }
        .form-group select { padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 1rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        .modal-btn { padding: 0.6rem 1.2rem; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; }
        #confirm-share-btn { background-color: var(--primary-color); color: #fff; }
        #cancel-share-btn { background-color: var(--border-color); }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <aside class="sidebar">
        <a href="dashboard.html" class="sidebar-header">Academate</a>
        <ul class="nav-menu">
            <li class="nav-item"><a href="dashboard.html"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span>Dasbor</span></a></li>
            <li class="nav-item"><a href="classes.html"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg><span>Kelas</span></a></li>
            <li class="nav-item"><a href="schedule.html"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>Jadwal</span></a></li>
            <li class="nav-item"><a href="notes.html" class="active"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg><span>Catatan</span></a></li>
            <li class="nav-item"><a href="account.html"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span>Akun</span></a></li>
        </ul>
        <button class="logout-button" id="logout-button"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg><span>Keluar</span></button>
    </aside>

    <main class="main-content">
        <div class="notes-list-panel">
            <div class="notes-list-header">
                <h1>Catatan</h1>
                <button class="new-note-btn" id="new-note-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                    <span>Baru</span>
                </button>
            </div>
            <div class="notes-list-controls">
                <div class="search-bar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                    <input type="text" id="search-input" placeholder="Cari catatan...">
                </div>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="personal">Catatan Saya</button>
                    <button class="tab-btn" data-tab="shared">Catatan Kelas</button>
                </div>
            </div>
            <ul id="notes-list-container">
                <div class="loader"></div>
            </ul>
        </div>
        <div class="note-panel">
             <div id="editor-placeholder">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                <h2>Pilih catatan untuk dilihat atau buat yang baru.</h2>
            </div>

            <div id="editor-container">
                <div class="editor-header">
                    <button class="editor-btn delete-btn" id="delete-note-btn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg><span>Hapus</span></button>
                    <button class="editor-btn share-btn" id="share-note-btn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/></svg><span>Bagikan</span></button>
                    <button class="editor-btn save-btn" id="save-note-btn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 8.036A5.53 5.53 0 0 1 7.583 4h.834a5.53 5.53 0 0 1 5.083 4.036.5.5 0 0 0 .917-.402A6.53 6.53 0 0 0 8.417 3H7.583A6.53 6.53 0 0 0 1.583 7.634a.5.5 0 0 0 .917.402z"/><path d="m9.22 10.323.333 1.665a.5.5 0 0 0 .94.004l1.463-3.657a.5.5 0 0 0-.825-.632l-3.32 2.37a.5.5 0 0 0 .004.94zm-2.48-1.55L4.935 9.14a.5.5 0 0 0-.632.825l2.37 3.32a.5.5 0 0 0 .94-.004l1.665-.333a.5.5 0 0 0 .004-.94l-3.657-1.463z"/></svg><span>Simpan</span></button>
                </div>
                <div class="title-wrapper">
                    <input type="text" id="note-title-input" placeholder="Judul Catatan...">
                </div>
                 <div id="note-meta"></div>
                <div id="quill-editor-container">
                    <div id="quill-editor"></div>
                </div>
                <div id="word-count">0 kata</div>
            </div>

            <div id="reader-container">
                <div class="reader-header">
                    <h2 id="reader-title"></h2>
                    <div class="reader-meta">
                        <div id="reader-author" class="reader-meta-item"></div>
                        <div id="reader-class" class="reader-meta-item"></div>
                        <div id="reader-date" class="reader-meta-item"></div>
                    </div>
                </div>
                <div class="reader-body">
                    <p id="reader-content"></p>
                </div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="share-modal">
        <div class="modal">
            <h2>Bagikan Catatan ke Kelas</h2>
            <div class="form-group">
                <label for="class-select">Pilih Kelas:</label>
                <select id="class-select"></select>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn" id="cancel-share-btn">Batal</button>
                <button type="button" class="modal-btn" id="confirm-share-btn">Bagikan</button>
            </div>
        </div>
    </div>
    
    <!-- Quill.js JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, arrayUnion, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyCGr2zchpiAiTn-bMFk-eLNE-1OgGzaSdA",
            authDomain: "acadmte.firebaseapp.com",
            projectId: "acadmte",
            storageBucket: "acadmte.appspot.com",
            messagingSenderId: "547286858993",
            appId: "1:547286858993:web:b83de49e7eb1cc35a67d50",
            measurementId: "G-ZEFYD7F650"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Management ---
        let currentUser = null;
        let currentNoteId = null;
        let currentNoteType = 'personal'; // 'personal' or 'shared'
        let activeTab = 'personal';
        let preselectedNote = null; // { noteId, classId } from URL
        let preselectedClassId = null; // for sharing from class page

        let personalNotesUnsubscribe = null, sharedNotesUnsubscribes = [];
        let quill;
        
        let allPersonalNotes = [], allSharedNotes = [], classDataCache = {};
        const classColors = ['#8B5CF6', '#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#EC4899'];

        // --- DOM Elements ---
        const notesListContainer = document.getElementById('notes-list-container');
        const searchInput = document.getElementById('search-input');
        const editorPlaceholder = document.getElementById('editor-placeholder');
        const editorContainer = document.getElementById('editor-container');
        const readerContainer = document.getElementById('reader-container');

        // --- Auth & Initial Load ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                initializePage();
            } else {
                if (personalNotesUnsubscribe) personalNotesUnsubscribe();
                sharedNotesUnsubscribes.forEach(unsub => unsub());
                window.location.replace('auth.html');
            }
        });

        function initializePage() {
            initializeQuill();
            handleUrlParameters();
            attachEventListeners();
            listenForPersonalNotes(currentUser.uid);
            loadAndListenForSharedNotes(currentUser.uid);
        }

        function initializeQuill() {
            quill = new Quill('#quill-editor', {
                modules: { toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]},
                theme: 'snow',
                placeholder: 'Tuliskan catatanmu di sini...',
            });
            quill.on('text-change', updateWordCount);
        }

        function handleUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            const noteId = params.get('noteId');
            const classId = params.get('classId');
            preselectedClassId = params.get('share_to');

            if (noteId && classId) {
                preselectedNote = { noteId, classId };
                activeTab = 'shared';
            }
            if (preselectedClassId) {
                handleNewNote();
            }

            // Clean the URL to avoid confusion on reload
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- Firestore Listeners ---
        function listenForPersonalNotes(userId) {
            const q = query(collection(db, 'users', userId, 'notes'), orderBy('updatedAt', 'desc'));
            personalNotesUnsubscribe = onSnapshot(q, (snapshot) => {
                allPersonalNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (activeTab === 'personal') {
                    renderNotesList(allPersonalNotes, 'personal');
                }
            }, console.error);
        }

        async function loadAndListenForSharedNotes(userId) {
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (!userDoc.exists()) return;

            const joinedClasses = userDoc.data().joinedClasses || [];
            if (joinedClasses.length === 0) {
                 if(activeTab === 'shared') renderNotesList([], 'shared');
                 return;
            }
            
            const classDocs = await Promise.all(joinedClasses.map(id => getDoc(doc(db, 'classes', id))));
            classDocs.forEach((classDoc, index) => {
                if(classDoc.exists()) {
                    classDataCache[classDoc.id] = { ...classDoc.data(), color: classColors[index % classColors.length] };
                }
            });

            sharedNotesUnsubscribes.forEach(unsub => unsub());
            sharedNotesUnsubscribes = [];

            let tempSharedNotes = [];
            let promises = joinedClasses.map(classId => 
                new Promise(resolve => {
                    const q = query(collection(db, 'classes', classId, 'sharedNotes'), orderBy('sharedAt', 'desc'));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const classNotes = snapshot.docs.map(d => ({ id: d.id, classId: classId, ...d.data() }));
                        
                        // Update the temporary list
                        tempSharedNotes = tempSharedNotes.filter(note => note.classId !== classId).concat(classNotes);
                        
                        // Sort and update the main list
                        allSharedNotes = [...tempSharedNotes].sort((a, b) => b.sharedAt.toMillis() - a.sharedAt.toMillis());

                        if (activeTab === 'shared') {
                            renderNotesList(allSharedNotes, 'shared');
                        }
                        
                        // If there's a preselected note, open it now that data is loaded
                        if (preselectedNote && classId === preselectedNote.classId) {
                            handleNoteSelect(preselectedNote.noteId, 'shared', preselectedNote.classId);
                            preselectedNote = null; // Consume it
                        }
                        resolve();
                    });
                    sharedNotesUnsubscribes.push(unsubscribe);
                })
            );
            await Promise.all(promises);
        }

        // --- UI Rendering ---
        function renderNotesList(notes, type) {
            notesListContainer.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const filteredNotes = notes.filter(note => 
                (note.title || '').toLowerCase().includes(searchTerm) || 
                ((note.plainText || note.body || '').toLowerCase().includes(searchTerm))
            );

            if (filteredNotes.length === 0) {
                notesListContainer.innerHTML = `<p style="padding: 1.5rem; text-align: center; color: var(--text-muted);">Tidak ada catatan ditemukan.</p>`;
                return;
            }

            filteredNotes.forEach(noteData => {
                const li = document.createElement('li');
                li.dataset.id = noteData.id;
                li.dataset.type = type;

                if (type === 'personal') {
                    li.className = 'note-item';
                    const isShared = noteData.sharedTo && noteData.sharedTo.length > 0;
                    li.innerHTML = `
                        <h3>${noteData.title || 'Tanpa Judul'}</h3>
                        <p class="note-excerpt">${noteData.plainText ? noteData.plainText.substring(0, 120) : 'Tidak ada konten'}</p>
                        <div class="note-footer">
                            <span>${noteData.updatedAt ? noteData.updatedAt.toDate().toLocaleDateString('id-ID') : ''}</span>
                            ${isShared ? '<span class="shared-tag">Dibagikan</span>' : ''}
                        </div>`;
                    li.addEventListener('click', () => handleNoteSelect(noteData.id, 'personal'));
                } else {
                    li.className = 'shared-note-item';
                    const classInfo = classDataCache[noteData.classId] || {};
                    li.dataset.classId = noteData.classId;
                    li.innerHTML = `
                        <h3>${noteData.title || 'Tanpa Judul'}</h3>
                        <p class="note-excerpt">${(noteData.body || '').substring(0, 120)}</p>
                        <div class="note-footer">
                            <div class="shared-note-meta">
                                <span class="class-color-dot" style="background-color: ${classInfo.color || '#ccc'};"></span>
                                <span class="class-name">${classInfo.namaMataKuliah || 'Kelas tidak diketahui'}</span>
                            </div>
                            <span>Oleh: ${noteData.sharedBy}</span>
                        </div>`;
                    li.addEventListener('click', () => handleNoteSelect(noteData.id, 'shared', noteData.classId));
                }
                notesListContainer.appendChild(li);
            });

            if (currentNoteId && type === currentNoteType) {
                const activeItem = notesListContainer.querySelector(`[data-id="${currentNoteId}"]`);
                if (activeItem) activeItem.classList.add('active');
            }
        }

        async function handleNoteSelect(noteId, type, classId = null) {
            currentNoteId = noteId;
            currentNoteType = type;

            editorPlaceholder.style.display = 'none';
            editorContainer.style.display = 'none';
            readerContainer.style.display = 'none';
            
            if (type === 'personal') {
                const noteData = allPersonalNotes.find(n => n.id === noteId);
                if (!noteData) return;
                
                document.getElementById('note-title-input').value = noteData.title;
                try {
                    quill.setContents(JSON.parse(noteData.contentDelta || '[]'));
                } catch (e) {
                    quill.setText('Gagal memuat konten.');
                }
                document.getElementById('note-meta').textContent = `Terakhir diperbarui: ${noteData.updatedAt.toDate().toLocaleString('id-ID')}`;
                updateWordCount();
                editorContainer.style.display = 'flex';
            } else if (type === 'shared') {
                const noteRef = doc(db, 'classes', classId, 'sharedNotes', noteId);
                const noteSnap = await getDoc(noteRef);
                if (!noteSnap.exists()) return;

                const noteData = noteSnap.data();
                const classInfo = classDataCache[classId] || {};

                document.getElementById('reader-title').textContent = noteData.title;
                document.getElementById('reader-author').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg><span>${noteData.sharedBy}</span>`;
                document.getElementById('reader-class').innerHTML = `<span class="class-color-dot" style="background-color: ${classInfo.color || '#ccc'};"></span><span>${classInfo.namaMataKuliah || ''}</span>`;
                document.getElementById('reader-date').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg><span>${noteData.sharedAt.toDate().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</span>`;
                document.getElementById('reader-content').innerHTML = `<p>${noteData.body.replace(/\n/g, '<br>')}</p>`;
                readerContainer.style.display = 'flex';
            }

            document.querySelectorAll('.note-item, .shared-note-item').forEach(item => item.classList.remove('active'));
            const activeItem = notesListContainer.querySelector(`[data-id="${noteId}"][data-type="${type}"]`);
            if (activeItem) activeItem.classList.add('active');
        }

        function handleNewNote() {
            currentNoteId = null;
            currentNoteType = 'personal';
            document.getElementById('note-title-input').value = '';
            quill.setContents([]);
            document.getElementById('note-meta').textContent = 'Catatan baru';
            updateWordCount();

            editorPlaceholder.style.display = 'none';
            readerContainer.style.display = 'none';
            editorContainer.style.display = 'flex';
            document.getElementById('note-title-input').focus();
            
            document.querySelectorAll('.note-item, .shared-note-item').forEach(item => item.classList.remove('active'));
        }

        function updateWordCount() {
            const text = quill.getText().trim();
            const wordCount = text.length > 0 ? text.split(/\s+/).length : 0;
            document.getElementById('word-count').textContent = `${wordCount} kata`;
        }
        
        // --- Event Listeners Setup ---
        function attachEventListeners() {
            document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            document.getElementById('new-note-btn').addEventListener('click', handleNewNote);
            searchInput.addEventListener('input', () => renderNotesList(activeTab === 'personal' ? allPersonalNotes : allSharedNotes, activeTab));
            
            document.querySelector('.tabs').addEventListener('click', (e) => {
                if(e.target.classList.contains('tab-btn')) {
                    activeTab = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    if (activeTab === 'personal') renderNotesList(allPersonalNotes, 'personal');
                    else renderNotesList(allSharedNotes, 'shared');
                }
            });

            if (preselectedNote) {
                const sharedTab = document.querySelector('.tab-btn[data-tab="shared"]');
                if(sharedTab) sharedTab.click();
            }

            // Editor buttons
            document.getElementById('save-note-btn').addEventListener('click', saveNote);
            document.getElementById('delete-note-btn').addEventListener('click', deleteNote);
            document.getElementById('share-note-btn').addEventListener('click', openShareModal);

            // Share Modal buttons
            document.getElementById('cancel-share-btn').addEventListener('click', () => document.getElementById('share-modal').style.display = 'none');
            document.getElementById('confirm-share-btn').addEventListener('click', confirmShare);
        }
        
        // --- CRUD & Actions ---
        async function saveNote() {
            if (!currentUser) return;
            const title = document.getElementById('note-title-input').value.trim();
            if (!title && quill.getLength() <= 1) { return alert("Catatan tidak boleh kosong."); }

            const btn = document.getElementById('save-note-btn');
            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            try {
                const noteData = {
                    title: title || 'Tanpa Judul',
                    contentDelta: JSON.stringify(quill.getContents()),
                    plainText: quill.getText(),
                    updatedAt: serverTimestamp()
                };

                if (!currentNoteId) {
                    noteData.createdAt = serverTimestamp();
                    const newDocRef = await addDoc(collection(db, 'users', currentUser.uid, 'notes'), noteData);
                    currentNoteId = newDocRef.id;
                    if (preselectedClassId) openShareModal();
                } else {
                    await updateDoc(doc(db, 'users', currentUser.uid, 'notes', currentNoteId), noteData);
                }
                document.getElementById('note-meta').textContent = `Tersimpan pada ${new Date().toLocaleTimeString('id-ID')}`;
            } catch (error) {
                console.error("Error saving note: ", error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 8.036A5.53 5.53 0 0 1 7.583 4h.834a5.53 5.53 0 0 1 5.083 4.036.5.5 0 0 0 .917-.402A6.53 6.53 0 0 0 8.417 3H7.583A6.53 6.53 0 0 0 1.583 7.634a.5.5 0 0 0 .917.402z"/><path d="m9.22 10.323.333 1.665a.5.5 0 0 0 .94.004l1.463-3.657a.5.5 0 0 0-.825-.632l-3.32 2.37a.5.5 0 0 0 .004.94zm-2.48-1.55L4.935 9.14a.5.5 0 0 0-.632.825l2.37 3.32a.5.5 0 0 0 .94-.004l1.665-.333a.5.5 0 0 0 .004-.94l-3.657-1.463z"/></svg><span>Simpan</span>`;
            }
        }

        async function deleteNote() {
            if (!currentNoteId || !currentUser || !confirm("Yakin ingin menghapus catatan ini?")) return;
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'notes', currentNoteId));
                currentNoteId = null;
                editorContainer.style.display = 'none';
                readerContainer.style.display = 'none';
                editorPlaceholder.style.display = 'block';
            } catch (error) { console.error("Error deleting note: ", error); }
        }

        async function openShareModal() {
            if (!currentNoteId) return alert("Simpan catatan terlebih dahulu.");
            
            const classSelect = document.getElementById('class-select');
            classSelect.innerHTML = '<option>Memuat kelas...</option>';
            document.getElementById('share-modal').style.display = 'flex';
            
            try {
                const userDocSnap = await getDoc(doc(db, 'users', currentUser.uid));
                const classIds = userDocSnap.data().joinedClasses || [];
                if (classIds.length === 0) {
                    classSelect.innerHTML = '<option>Anda belum gabung kelas</option>'; return;
                }

                classSelect.innerHTML = Object.entries(classDataCache)
                    .map(([id, data]) => `<option value="${id}">${data.namaMataKuliah}</option>`).join('');
                
                if (preselectedClassId) classSelect.value = preselectedClassId;
            } catch (error) {
                console.error("Error loading classes for sharing:", error);
                classSelect.innerHTML = '<option>Gagal memuat kelas</option>';
            }
        }

        async function confirmShare() {
            const selectedClassId = document.getElementById('class-select').value;
            if (!selectedClassId || !currentNoteId) return;

            const btn = document.getElementById('confirm-share-btn');
            btn.disabled = true;
            btn.textContent = "Membagikan...";

            try {
                const noteRef = doc(db, 'users', currentUser.uid, 'notes', currentNoteId);
                const noteSnap = await getDoc(noteRef);
                
                if (noteSnap.exists()) {
                    const noteData = noteSnap.data();
                    await addDoc(collection(db, 'classes', selectedClassId, 'sharedNotes'), {
                        originalNoteId: currentNoteId,
                        originalOwnerId: currentUser.uid,
                        title: noteData.title,
                        body: noteData.plainText,
                        sharedBy: currentUser.displayName || 'Anonymous',
                        sharedByPhotoURL: currentUser.photoURL || null,
                        sharedAt: serverTimestamp()
                    });
                    await updateDoc(noteRef, { sharedTo: arrayUnion(selectedClassId) });
                    
                    document.getElementById('share-modal').style.display = 'none';
                    preselectedClassId = null;
                }
            } catch (error) {
                console.error("Error sharing note:", error);
            } finally {
                btn.disabled = false;
                btn.textContent = "Bagikan";
            }
        }
    </script>
</body>
</html>
