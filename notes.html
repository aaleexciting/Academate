<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catatan — Academate</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css">
  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <style>
    :root{
      --bg:#F7F7FA;--surface:#fff;--text:#1E1F24;--muted:#6C6F7F;--primary:#6F6CFF;--primary-2:#8B7CFF;--border:#ECECF1;--shadow:0 6px 24px rgba(30,31,36,.07);--radius:18px;--sidebar-w:280px;--content-max:1320px;--gap:18px;
      --success:#10B981;--warn:#F59E0B;--danger:#EF4444;--info:#3B82F6;
    }
    html,body{height:100%}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;font-size:15px;padding-bottom:80px}
    a{color:inherit; text-decoration: none;}

    /* App Shell */
    .app{padding:var(--gap);width:100%;max-width:1700px;margin:0 auto;min-height:100dvh}
    .main{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .main-content{padding:var(--gap);width:100%}

    /* Sidebar */
    .sidebar{display:none}
    @media (min-width:901px){
      body{padding-bottom:0}
      .app{display:grid;grid-template-columns:var(--sidebar-w) minmax(0,1fr);gap:24px}
      .sidebar{display:flex;flex-direction:column;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px}
      .brand{display:flex;align-items:center;gap:12px;font-weight:700;font-size:22px;margin-bottom:18px}
      .brand .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#8B7CFF,#6AC9FF)}
      .nav{display:flex;flex-direction:column;gap:8px;overflow:auto;padding-right:2px}
      .nav a{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;color:var(--muted);text-decoration:none;font-weight:500;transition:.2s}
      .nav a i{font-size:20px}
      .nav a:hover{background:#F3F2FF;color:var(--primary)}
      .nav a.active{background:var(--primary);color:#fff;box-shadow:0 8px 20px rgba(111,108,255,.3)}
      .spacer{flex:1}
      .sidebar-footer{margin-top:auto;padding-top:16px;border-top:1px solid var(--border)}
      .sidebar-logout-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:12px;border-radius:12px;background:transparent;border:1px solid var(--border);color:var(--muted);font-weight:600;cursor:pointer;transition:.2s}
      .sidebar-logout-btn:hover{background:#fde2e2;border-color:#f7b2b2;color:#c82424}
      .sidebar-links{text-align:center;margin-top:16px;display:flex;justify-content:center;gap:16px}
      .sidebar-links a{font-size:12px;color:var(--muted);text-decoration:none}
      .sidebar-links a:hover{text-decoration:underline}
      .copyright{font-size:11px;color:#C0C3D2;text-align:center;margin-top:12px}
    }

    /* Header */
    .header{margin-top:var(--gap);margin-bottom:24px}
    .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .header-brand{font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--primary-2));-webkit-background-clip:text;background-clip:text;color:transparent;display:inline-block}
    .header-actions{display:flex;gap:8px}
    .header-actions .icon-btn{width:38px;height:38px;font-size:18px}
    .header-main{display:flex;justify-content:space-between;align-items:center;gap:16px}
    .header-main h1{font-size:22px;margin:0}
    .header-main p{color:var(--muted);margin:4px 0 0;font-size:14px}
    .header-avatar-link{text-decoration:none}
    .header-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0}
    
    /* Toolbar & Filters */
    .toolbar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .search-bar{position:relative; flex-grow: 1;}
    .search-bar input{width:100%; padding:12px 16px 12px 44px;border-radius:12px;border:1px solid var(--border);background:var(--surface);outline:none;transition:.2s}
    .search-bar input:focus{border-color:var(--primary);background:var(--surface)}
    .search-bar i{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--surface);cursor:pointer;font-weight:600;text-decoration:none;transition:.2s}
    .btn:hover{border-color:#d8d8e0}
    .btn-primary{background:var(--primary);color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(111,108,255,.28)}
    
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      background: var(--bg);
      border-radius: 12px;
      margin-top: 16px;
    }
    .filter-group { display: flex; align-items: center; gap: 8px; }
    .filter-group label { font-size: 13px; font-weight: 500; color: var(--muted); }
    .filter-group select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-weight: 500;
      cursor: pointer;
    }
    .filter-group select:focus { outline-color: var(--primary); }
    .tabs{display:flex;border:1px solid var(--border);border-radius:10px;background:var(--surface);padding:4px}
    .tab-btn{padding:6px 12px;border:none;background:none;border-radius:8px;font-weight:600;color:var(--muted);cursor:pointer}
    .tab-btn.active{background:#F3F2FF;color:var(--primary)}


    /* Desktop header overrides */
    @media (min-width:901px){
      .main-content{max-width:min(var(--content-max),calc(100vw - var(--sidebar-w) - 120px));margin:0 auto}
      .header{display:flex;justify-content:space-between;align-items:center}
      .header-top,.header-avatar-link,.header-actions{display:none}
      .header-main{display:block}
      .header-main h1{font-size:26px}
      .header-main p{font-size:15px;margin-top:6px}
    }

    /* Mobile nav */
    .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;justify-content:space-around;align-items:center;height:70px;padding:0 10px;z-index:1000}
    .mobile-nav a{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);text-decoration:none;font-size:10px;font-weight:500;padding:8px;border-radius:8px}
    .mobile-nav a i{font-size:20px}
    .mobile-nav a.active{color:var(--primary)}
    @media (min-width:901px){.mobile-nav{display:none}}

    /* === NOTES PAGE REDESIGN === */
    .page-layout { display: none; } /* Hide layout until ready */
    .page-layout.ready { display: block; }
    
    .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--gap);
        margin-top: 24px;
    }

    .note-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        cursor: pointer;
        transition: transform .2s, box-shadow .2s;
        display: flex;
        flex-direction: column;
    }
    .note-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }
    .note-card-body { padding: 16px; flex-grow: 1; display: flex; flex-direction: column; }
    .note-card h3 { margin: 0 0 8px; font-size: 16px; }
    .note-card .excerpt {
        font-size: 14px;
        color: var(--muted);
        flex-grow: 1;
        line-height: 1.6;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .note-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        font-size: 12px;
        color: var(--muted);
    }
    .tag-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #F3F2FF;
        border: 1px solid #E7E6FF;
        border-radius: 999px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 500;
        color: var(--primary);
    }
    .tag-pill .dot { width: 8px; height: 8px; border-radius: 50%; }

    /* Shared Note Card styling */
    .note-card.shared { background-color: #FDFDFD; }
    .shared-author-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        font-size: 12px;
        font-weight: 500;
        border-bottom: 1px solid var(--border);
    }
    .shared-author-header img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
    }
    .shared-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .shared-pill {
      background: var(--surface);
      border: 1px solid var(--border);
      font-size: 14px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }


    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .loader { border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; margin: 60px auto; }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    /* === EDITOR / READER OVERLAY === */
    .overlay-container {
        position: fixed;
        inset: 0;
        background: rgba(247, 247, 250, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        opacity: 0;
        visibility: hidden;
        transition: opacity .3s, visibility .3s;
    }
    .overlay-container.show { opacity: 1; visibility: visible; }
    
    .overlay-content { width: 100%; max-width: 900px; margin: 0 auto; padding: 24px; flex-grow: 1; display: flex; flex-direction: column; }
    .overlay-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; flex-shrink: 0; }
    .overlay-actions { display: flex; gap: 8px; align-items: center; }
    .icon-btn{width:42px;height:42px;border-radius:12px;border:1px solid var(--border);background:var(--surface);display:grid;place-items:center;cursor:pointer;color:var(--muted);font-size:20px;transition:.2s;flex-shrink:0}
    .icon-btn:hover{color:var(--primary);border-color:#d8d8e0}
    
    /* Editor Specific */
    #note-title-input {
        flex-grow: 1;
        border: none;
        outline: none;
        font-size: 28px;
        font-weight: 700;
        background: transparent;
        padding: 8px 0;
    }
    .editor-meta-bar { display: flex; justify-content: space-between; align-items: center; gap: 12px; font-size: 12px; color: var(--muted); padding-bottom: 12px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tag-editor{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .tag-editor .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px; background: #fff;}
    .tag-editor .chip button{border:none;background:transparent;cursor:pointer;color:var(--muted)}
    .tag-selector{position:relative}
    .tag-selector .icon-btn{background: transparent; border: 1px dashed var(--border);}
    .tag-dropdown{position:absolute;top:110%;left:0;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);min-width:220px;display:none;z-index:10; padding: 4px;}
    .tag-dropdown .opt{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer; border-radius: 8px;}
    .tag-dropdown .opt:hover{background:#F7F7FA}
    #quill-editor-container { flex-grow: 1; position: relative; margin: 0 -24px; }
    .ql-toolbar.ql-snow{border:none !important; border-bottom:1px solid var(--border) !important; padding:12px 24px !important; position: sticky; top:0; background: rgba(247, 247, 250, 0.8); backdrop-filter: blur(4px); z-index: 5;}
    .ql-container.ql-snow{border:none !important;}
    .ql-editor{font-size:16px;line-height:1.8;padding:24px; background: transparent !important;}
    
    /* Reader Specific */
    #reader-title { font-size: 28px; font-weight: 700; margin: 0; }
    .reader-meta { font-size: 13px; color: var(--muted); margin-top: 8px; display: flex; gap: 12px; align-items: center; }
    #reader-body { flex-grow: 1; overflow-y: auto; line-height: 1.9; font-size: 17px; padding-top: 24px; }

    /* Focus Mode */
    body.focus-mode .sidebar, body.focus-mode .header, body.focus-mode .mobile-nav, body.focus-mode .main > .main-content > *:not(.overlay-container) { display: none !important; }
    body.focus-mode .app, body.focus-mode .main, body.focus-mode .main-content { padding: 0; }

    /* Share Modal */
    .modal-overlay { position:fixed; inset:0; background:rgba(17,24,39,.55); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); align-items:center; justify-content:center; z-index:2100; display: none; }
    .modal-overlay.show { display: flex; }
    .modal { background:#fff; padding:20px; border-radius:16px; width:90%; max-width:420px; box-shadow:var(--shadow); }
    
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigasi utama">
      <div class="brand"><div class="logo" aria-hidden="true"></div>Academate</div>
      <nav class="nav">
        <a href="dashboard.html"><i class="ri-dashboard-2-line"></i><span>Dasbor</span></a>
        <a href="classes.html"><i class="ri-book-open-line"></i><span>Kelas</span></a>
        <a href="task.html"><i class="ri-task-line"></i><span>Tugas</span></a>
        <a href="schedule.html"><i class="ri-calendar-2-line"></i><span>Jadwal</span></a>
        <a class="active" href="notes.html"><i class="ri-file-list-3-line"></i><span>Catatan</span></a>
        <a href="account.html"><i class="ri-user-3-line"></i><span>Akun</span></a>
      </nav>
      <div class="spacer"></div>
      <div class="sidebar-footer">
        <button id="logout-button-desktop" class="sidebar-logout-btn" type="button" title="Keluar"><i class="ri-logout-box-r-line"></i><span>Keluar</span></button>
        <div class="sidebar-links"><a href="#">Terms of Service</a><a href="#">Privacy Policy</a></div>
        <p class="copyright">&copy; 2025 Academate</p>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="main-content">
        <div class="page-layout">
            <header class="header">
              <div class="header-main">
                <div>
                  <h1>Pusat Catatan</h1>
                  <p>Tulis, organisir, dan berkolaborasi dalam semua catatan Anda.</p>
                </div>
                <a href="account.html" class="header-avatar-link"><img id="header-avatar-img" class="header-avatar" alt="Foto profil"></a>
              </div>
            </header>

            <div class="toolbar">
              <div class="search-bar">
                <i class="ri-search-line"></i>
                <input id="search-input" type="text" placeholder="Cari di semua catatan...">
              </div>
              <button class="btn btn-primary" id="new-note-btn"><i class="ri-add-line"></i><span>Catatan Baru</span></button>
            </div>
            
            <div class="filter-bar">
                <div class="filter-group tabs">
                    <button class="tab-btn active" data-filter="all">Semua</button>
                    <button class="tab-btn" data-filter="personal">Pribadi</button>
                    <button class="tab-btn" data-filter="shared">Dibagikan</button>
                </div>
                <div class="filter-group">
                    <label for="class-filter">Mata Kuliah:</label>
                    <select id="class-filter">
                        <option value="all">Semua</option>
                    </select>
                </div>
            </div>

            <div id="notes-grid" class="notes-grid" aria-live="polite">
                <div class="loader"></div>
            </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Nav -->
  <nav class="mobile-nav">
    <a href="dashboard.html"><i class="ri-dashboard-2-line"></i><span>Dasbor</span></a>
    <a href="classes.html"><i class="ri-book-open-line"></i><span>Kelas</span></a>
    <a href="task.html"><i class="ri-task-line"></i><span>Tugas</span></a>
    <a href="schedule.html"><i class="ri-calendar-2-line"></i><span>Jadwal</span></a>
    <a class="active" href="notes.html"><i class="ri-file-list-3-line"></i><span>Catatan</span></a>
  </nav>

  <!-- Editor Overlay -->
  <div id="editor-overlay" class="overlay-container">
    <div class="overlay-content">
        <div class="overlay-header">
            <button id="back-to-list-btn" class="icon-btn" title="Kembali ke Daftar"><i class="ri-arrow-left-line"></i></button>
            <input id="note-title-input" placeholder="Judul Catatan...">
            <div class="overlay-actions">
                <button id="toggle-focus-btn" class="icon-btn" title="Mode Fokus"><i class="ri-fullscreen-line"></i></button>
                <button id="share-btn" class="icon-btn" title="Bagikan"><i class="ri-share-forward-line"></i></button>
                <button id="delete-btn" class="icon-btn" title="Hapus"><i class="ri-delete-bin-line"></i></button>
            </div>
        </div>
        <div class="editor-meta-bar">
            <div class="tag-editor">
                <div id="tag-chips"></div>
                <div class="tag-selector">
                    <button id="add-tag-btn" type="button" class="icon-btn" title="Tambah Tag Kelas"><i class="ri-add-line"></i></button>
                    <div id="tag-dropdown" class="tag-dropdown"></div>
                </div>
            </div>
            <span id="word-count">0 kata</span>
        </div>
        <div id="quill-editor-container">
            <div id="quill-editor"></div>
        </div>
    </div>
  </div>

  <!-- Reader Overlay for Shared Notes -->
  <div id="reader-overlay" class="overlay-container">
    <div class="overlay-content">
        <div class="overlay-header">
            <button id="reader-back-btn" class="icon-btn" title="Kembali ke Daftar"><i class="ri-arrow-left-line"></i></button>
            <div style="flex-grow:1;">
                <h2 id="reader-title"></h2>
                <div class="reader-meta">
                    <span id="reader-author"></span>
                    <span id="reader-date"></span>
                </div>
            </div>
        </div>
        <div id="reader-body"></div>
    </div>
  </div>


  <!-- Share Modal -->
  <div class="modal-overlay" id="share-modal">
    <div class="modal">
      <h3 style="margin:0 0 8px">Bagikan ke Kelas</h3>
      <p style="color:var(--muted);margin:0 0 12px">Pilih kelas tujuan:</p>
      <select id="share-class" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg)"></select>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="share-cancel" class="btn">Batal</button>
        <button id="share-confirm" class="btn btn-primary">Bagikan</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCGr2zchpiAiTn-bMFk-eLNE-1OgGzaSdA", authDomain: "acadmte.firebaseapp.com", projectId: "acadmte", storageBucket: "acadmte.appspot.com", messagingSenderId: "547286858993", appId: "1:547286858993:web:b83de49e7eb1cc35a67d50", measurementId: "G-ZEFYD7F650" };

    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

    let currentUser = null, currentNoteId = null, notesUnsubscriber = null, quill, classesCache = {}, allNotes = [];
    let saveTimer = null, isSaving = false, currentNoteTags = [];
    let currentFilters = { type: 'all', class: 'all' };

    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.replace('auth.html'); return; }
      currentUser = user;
      hydrateAvatar();
      initQuill();
      await loadClasses();
      attachEventListeners();
      listenToAllNotes();
      handleUrlParams();
      $('.page-layout').classList.add('ready');
    });
    
    function hydrateAvatar() {
        const avatar = $('#header-avatar-img');
        if (!avatar) return;
        const name = localStorage.getItem('userDisplayName') || (currentUser?.displayName ?? 'A');
        const photo = localStorage.getItem('userPhotoURL') || currentUser?.photoURL;
        avatar.src = photo || `https://placehold.co/80x80/E5E7EB/6B7280?text=${(name || 'A').charAt(0)}`;
    }

    function initQuill() {
        quill = new Quill('#quill-editor', {
            theme: 'snow',
            placeholder: 'Mulai tulis sesuatu yang luar biasa...',
            modules: { toolbar: [[{ header: [1, 2, 3, false] }], ["bold", "italic", "underline"], [{ list: 'ordered' }, { list: 'bullet' }], ["link"], ['clean']] }
        });
        quill.on('text-change', () => {
            updateWordCount();
            scheduleAutoSave();
        });
    }
    
    async function loadClasses(){
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        const classIds = userDoc.exists() ? (userDoc.data().joinedClasses || []) : [];
        if (!classIds.length) return;
        const snaps = await Promise.all(classIds.map(id => getDoc(doc(db, 'classes', id))));
        snaps.forEach(s => { if(s.exists()) classesCache[s.id] = s.data(); });
        rebuildTagDropdown();
        
        const classFilter = $('#class-filter');
        classFilter.innerHTML = '<option value="all">Semua Mata Kuliah</option>';
        Object.entries(classesCache).forEach(([id, c]) => {
            classFilter.innerHTML += `<option value="${id}">${escapeHTML(c.namaMataKuliah || 'Kelas')}</option>`;
        });
        
        const shareSelect = $('#share-class');
        if (shareSelect) {
            shareSelect.innerHTML = Object.entries(classesCache).map(([id, c]) => `<option value="${id}">${escapeHTML(c.namaMataKuliah || 'Kelas')}</option>`).join('');
        }
    }

    function listenToAllNotes() {
        if (notesUnsubscriber) notesUnsubscriber();
        let personalNotes = [];
        let sharedNotes = [];
        const classIds = Object.keys(classesCache);
        
        const personalQuery = query(collection(db, 'users', currentUser.uid, 'notes'), orderBy('updatedAt', 'desc'));
        const personalUnsub = onSnapshot(personalQuery, (snapshot) => {
            personalNotes = snapshot.docs.map(d => ({ id: d.id, type: 'personal', ...d.data() }));
            updateAndRenderNotes(personalNotes, sharedNotes);
        });

        const sharedUnsubs = classIds.map(classId => {
            const sharedQuery = query(collection(db, 'classes', classId, 'sharedNotes'), orderBy('sharedAt', 'desc'));
            return onSnapshot(sharedQuery, (snapshot) => {
                const notesForClass = snapshot.docs.map(d => ({ id: d.id, classId, type: 'shared', ...d.data() }));
                sharedNotes = sharedNotes.filter(n => n.classId !== classId).concat(notesForClass);
                updateAndRenderNotes(personalNotes, sharedNotes);
            });
        });
        
        notesUnsubscriber = () => [personalUnsub, ...sharedUnsubs].forEach(unsub => unsub());
    }

    function updateAndRenderNotes(personal, shared) {
        const externalSharedNotes = shared.filter(note => note.originalOwnerId !== currentUser.uid);
        allNotes = [...personal, ...externalSharedNotes];
        allNotes.sort((a,b) => (b.updatedAt?.toMillis() || b.sharedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || a.sharedAt?.toMillis() || 0));
        renderNotesGrid();
    }

    function renderNotesGrid() {
        const grid = $('#notes-grid');
        const searchQuery = ($('#search-input').value || '').toLowerCase();
        
        let filteredNotes = allNotes.filter(note => 
            (note.title || '').toLowerCase().includes(searchQuery) || 
            (note.plainText || note.body || '').toLowerCase().includes(searchQuery)
        );

        if (currentFilters.type !== 'all') {
            filteredNotes = filteredNotes.filter(note => note.type === currentFilters.type);
        }
        
        if (currentFilters.class !== 'all') {
            filteredNotes = filteredNotes.filter(note => {
                if (note.type === 'personal') return (note.tags || []).includes(currentFilters.class);
                if (note.type === 'shared') return note.classId === currentFilters.class;
                return false;
            });
        }

        if (filteredNotes.length === 0) {
            grid.innerHTML = `<div class="empty-state"><h3>Tidak Ada Catatan</h3><p>Coba sesuaikan filter atau buat catatan baru.</p></div>`;
            return;
        }

        grid.innerHTML = '';
        filteredNotes.forEach(note => {
            const card = document.createElement('div');
            card.className = `note-card ${note.type}`;
            card.dataset.noteId = note.id;
            card.dataset.type = note.type;
            if (note.type === 'shared') card.dataset.classId = note.classId;

            if (note.type === 'shared') {
                card.innerHTML += `
                    <div class="shared-author-header">
                        <img src="${note.sharedByPhotoURL || 'https://placehold.co/48x48/E5E7EB/6B7280?text=A'}" alt="${escapeHTML(note.sharedBy)}">
                        <span>Dibagikan oleh <strong>${escapeHTML(note.sharedBy)}</strong></span>
                    </div>`;
            }

            const cardBody = document.createElement('div');
            cardBody.className = 'note-card-body';

            const tagId = note.type === 'personal' ? (note.tags && note.tags.length > 0 ? note.tags[0] : null) : note.classId;
            const tagInfo = tagId ? classesCache[tagId] : null;
            
            const sharedToIndicator = (note.type === 'personal' && note.sharedTo && note.sharedTo.length > 0)
                ? `<div class="shared-indicator" title="Dibagikan ke kelas">
                     ${note.sharedTo.map(id => `<span class="shared-pill">${classesCache[id]?.classIcon || '✔️'}</span>`).join('')}
                   </div>`
                : '';

            cardBody.innerHTML = `
                <h3>${escapeHTML(note.title || 'Tanpa Judul')}</h3>
                <p class="excerpt">${escapeHTML((note.plainText || note.body || '').substring(0, 150))}</p>
                <div class="note-card-footer">
                    <span>${formatDate(note.updatedAt || note.sharedAt)}</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      ${sharedToIndicator}
                      ${tagInfo ? `<div class="tag-pill"><span class="dot" style="background:${colorFor(tagId)}"></span>${escapeHTML(tagInfo.namaMataKuliah)}</div>` : ''}
                    </div>
                </div>
            `;
            card.appendChild(cardBody);
            card.addEventListener('click', () => {
                if (note.type === 'personal') openEditor(note.id);
                else openReader(note.id, note.classId);
            });
            grid.appendChild(card);
        });
    }

    function openEditor(noteId) {
        currentNoteId = noteId;
        const overlay = $('#editor-overlay');
        
        if (noteId === 'new') {
            $('#note-title-input').value = '';
            quill.setContents([]);
            currentNoteTags = [];
        } else {
            const note = allNotes.find(n => n.id === noteId && n.type === 'personal');
            if (!note) return;
            $('#note-title-input').value = note.title || '';
            try { quill.setContents(JSON.parse(note.contentDelta || '[]')); } catch { quill.setText(note.plainText || ''); }
            currentNoteTags = note.tags || [];
        }

        updateWordCount();
        updateTagEditor();
        overlay.classList.add('show');
    }

    async function openReader(noteId, classId) {
        const overlay = $('#reader-overlay');
        try {
            const noteSnap = await getDoc(doc(db, 'classes', classId, 'sharedNotes', noteId));
            if (!noteSnap.exists()) {
                alert('Catatan yang dibagikan tidak ditemukan.');
                return;
            }
            const note = noteSnap.data();
            $('#reader-title').textContent = escapeHTML(note.title);
            $('#reader-author').textContent = `Oleh ${escapeHTML(note.sharedBy)}`;
            $('#reader-date').textContent = formatDate(note.sharedAt);
            $('#reader-body').innerHTML = escapeHTML(note.body).replace(/\n/g, '<br>');
            overlay.classList.add('show');
        } catch (err) {
            console.error("Error fetching shared note:", err);
            alert("Gagal membuka catatan.");
        }
    }

    function closeEditor() {
        scheduleAutoSave(true); // Force save on close
        $('#editor-overlay').classList.remove('show');
        document.body.classList.remove('focus-mode');
        currentNoteId = null;
    }
    
    function closeReader() {
        $('#reader-overlay').classList.remove('show');
    }

    function scheduleAutoSave(force = false) {
        if (saveTimer) clearTimeout(saveTimer);
        const saveAction = async () => {
            if (isSaving || !currentNoteId) return;
            isSaving = true;

            const title = $('#note-title-input').value.trim() || 'Tanpa Judul';
            const payload = {
                title,
                contentDelta: JSON.stringify(quill.getContents()),
                plainText: quill.getText(),
                updatedAt: serverTimestamp(),
                tags: currentNoteTags
            };

            try {
                if (currentNoteId === 'new') {
                    payload.createdAt = serverTimestamp();
                    const ref = await addDoc(collection(db, 'users', currentUser.uid, 'notes'), payload);
                    currentNoteId = ref.id;
                } else {
                    await updateDoc(doc(db, 'users', currentUser.uid, 'notes', currentNoteId), payload);
                }
            } catch (e) { console.error("Autosave failed:", e); } 
            finally { isSaving = false; }
        };

        if (force) {
            saveAction();
        } else {
            saveTimer = setTimeout(saveAction, 1500);
        }
    }
    
    function updateWordCount() {
        const text = quill.getText().trim();
        const count = text ? text.split(/\s+/).length : 0;
        $('#word-count').textContent = `${count} kata`;
    }

    function updateTagEditor() {
        const container = $('#tag-chips');
        container.innerHTML = '';
        currentNoteTags.forEach(tagId => {
            const classInfo = classesCache[tagId];
            if (!classInfo) return;
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.innerHTML = `
                <span class="dot" style="background:${colorFor(tagId)}"></span>
                ${escapeHTML(classInfo.namaMataKuliah)}
                <button data-tag-id="${tagId}">&times;</button>
            `;
            chip.querySelector('button').addEventListener('click', () => removeTag(tagId));
            container.appendChild(chip);
        });
    }

    function removeTag(tagId) {
        currentNoteTags = currentNoteTags.filter(id => id !== tagId);
        updateTagEditor();
        scheduleAutoSave();
    }
    
    function addTag(tagId) {
        if (!currentNoteTags.includes(tagId)) {
            currentNoteTags.push(tagId);
            updateTagEditor();
            scheduleAutoSave();
        }
        $('#tag-dropdown').style.display = 'none';
    }

    function rebuildTagDropdown() {
        const dropdown = $('#tag-dropdown');
        dropdown.innerHTML = '';
        Object.entries(classesCache).forEach(([id, c]) => {
            const opt = document.createElement('div');
            opt.className = 'opt';
            opt.innerHTML = `<span class="dot" style="background:${colorFor(id)}"></span><span>${escapeHTML(c.namaMataKuliah)}</span>`;
            opt.addEventListener('click', () => addTag(id));
            dropdown.appendChild(opt);
        });
    }
    
    async function deleteCurrentNote() {
        if (!currentNoteId || currentNoteId === 'new') {
            closeEditor();
            return;
        }
        if (confirm('Anda yakin ingin menghapus catatan ini?')) {
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'notes', currentNoteId));
                closeEditor();
            } catch (err) {
                console.error("Gagal menghapus catatan:", err);
                alert('Gagal menghapus catatan.');
            }
        }
    }

    async function shareCurrentNote() {
        if (!currentNoteId || currentNoteId === 'new') {
            alert('Harap simpan catatan terlebih dahulu sebelum membagikan.');
            return;
        }
        $('#share-modal').classList.add('show');
    }
    
    async function confirmShare() {
        const classId = $('#share-class').value;
        if (!classId) return;
        
        await scheduleAutoSave(true);
        
        const noteRef = doc(db, 'users', currentUser.uid, 'notes', currentNoteId);
        const noteSnap = await getDoc(noteRef);
        if (!noteSnap.exists()) {
            alert('Catatan tidak ditemukan.'); return;
        }
        const noteData = noteSnap.data();

        try {
            await addDoc(collection(db, 'classes', classId, 'sharedNotes'), {
                originalNoteId: currentNoteId,
                originalOwnerId: currentUser.uid,
                title: noteData.title,
                body: noteData.plainText,
                sharedBy: currentUser.displayName,
                sharedByPhotoURL: currentUser.photoURL,
                sharedAt: serverTimestamp()
            });
            
            await updateDoc(noteRef, { 
                sharedTo: arrayUnion(classId),
                tags: arrayUnion(classId)
            });

            currentNoteTags = [...new Set([...(currentNoteTags || []), classId])];
            updateTagEditor();

            $('#share-modal').classList.remove('show');
            alert('Catatan berhasil dibagikan!');
        } catch(e) {
            console.error(e);
            alert('Gagal membagikan catatan.');
        }
    }

    function handleUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const noteId = params.get('note_id');
        const classId = params.get('class_id');
        if (noteId && classId) {
            openReader(noteId, classId);
            window.history.replaceState({}, document.title, window.location.pathname); 
        }
    }

    function attachEventListeners() {
        $('#logout-button-desktop')?.addEventListener('click', () => signOut(auth));
        $('#new-note-btn').addEventListener('click', () => openEditor('new'));
        $('#search-input').addEventListener('input', renderNotesGrid);
        
        // Filters
        $('.tabs').addEventListener('click', (e) => {
            if (e.target.matches('.tab-btn')) {
                $('.tabs .active').classList.remove('active');
                e.target.classList.add('active');
                currentFilters.type = e.target.dataset.filter;
                renderNotesGrid();
            }
        });
        $('#class-filter').addEventListener('change', (e) => {
            currentFilters.class = e.target.value;
            renderNotesGrid();
        });

        // Editor controls
        $('#back-to-list-btn').addEventListener('click', closeEditor);
        $('#reader-back-btn').addEventListener('click', closeReader);
        $('#delete-btn').addEventListener('click', deleteCurrentNote);
        $('#share-btn').addEventListener('click', shareCurrentNote);

        $('#toggle-focus-btn').addEventListener('click', () => {
            document.body.classList.toggle('focus-mode');
            $('#toggle-focus-btn i').classList.toggle('ri-fullscreen-line');
            $('#toggle-focus-btn i').classList.toggle('ri-fullscreen-exit-line');
            quill.focus();
        });

        $('#add-tag-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = $('#tag-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('.tag-selector')) {
                $('#tag-dropdown').style.display = 'none';
            }
        });
        
        // Share modal
        $('#share-confirm').addEventListener('click', confirmShare);
        $('#share-cancel').addEventListener('click', () => $('#share-modal').classList.remove('show'));
    }

    // --- Helpers ---
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }
    function formatDate(ts){ try{ return ts?.toDate?.().toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }) || ''; }catch{ return '' } }
    function colorFor(id) {
        const colors=['#8B5CF6','#10B981','#F59E0B','#EF4444','#3B82F6','#EC4899','#06B6D4','#84CC16'];
        let hash = 0;
        for (let i = 0; i < id.length; i++) { hash = (hash * 31 + id.charCodeAt(i)) >>> 0; }
        return colors[hash % colors.length];
    }

  </script>
</body>
</html>

