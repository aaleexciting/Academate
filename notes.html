<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Pribadi - Academate</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #7C3AED;
            --primary-light: #F5F3FF;
            --text-dark: #111827;
            --text-light: #374151;
            --text-muted: #6B7280;
            --bg-body: #F9FAFB;
            --bg-sidebar: #FFFFFF;
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* --- Sidebar --- */
        .sidebar { width: 260px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 1.5rem; }
        .sidebar-header { font-size: 1.75rem; font-weight: 700; color: var(--primary-color); text-decoration: none; margin-bottom: 2.5rem; padding: 0 0.5rem; }
        .nav-menu { list-style: none; flex-grow: 1; }
        .nav-item a { display: flex; align-items: center; padding: 0.85rem 1rem; text-decoration: none; color: var(--text-light); font-weight: 500; border-radius: 0.5rem; margin-bottom: 0.5rem; transition: background-color 0.2s ease, color 0.2s ease; }
        .nav-item a:hover { background-color: var(--primary-light); color: var(--primary-color); }
        .nav-item a.active { background-color: var(--primary-color); color: #fff; font-weight: 600; }
        .nav-item a svg { width: 20px; height: 20px; margin-right: 1rem; }
        .logout-button { display: flex; align-items: center; padding: 0.85rem 1rem; text-decoration: none; color: var(--text-light); font-weight: 500; border-radius: 0.5rem; background-color: transparent; border: none; width: 100%; font-family: 'Inter', sans-serif; font-size: 1rem; cursor: pointer; }
        .logout-button:hover { background-color: #FEE2E2; color: #EF4444; }

        /* --- Main Content --- */
        .main-content { flex-grow: 1; display: flex; overflow: hidden; }

        /* Notes List Panel */
        .notes-list-panel {
            width: 350px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background-color: #FFFFFF;
        }
        .notes-list-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .notes-list-header h1 { font-size: 1.75rem; margin-bottom: 1rem; }
        .new-note-btn { width: 100%; padding: 0.75rem; background-color: var(--primary-color); color: #fff; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .new-note-btn:hover { background-color: #6D28D9; }
        
        .search-bar-wrapper { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); }
        .search-bar { display: flex; align-items: center; background-color: var(--bg-body); border-radius: 0.5rem; padding: 0.5rem 0.75rem; }
        .search-bar svg { color: var(--text-muted); margin-right: 0.5rem; }
        .search-bar input { flex-grow: 1; border: none; background: transparent; font-size: 1rem; outline: none; }
        
        #notes-list { list-style: none; overflow-y: auto; flex-grow: 1; }
        .note-item, .shared-note-item { padding: 1.25rem 1.5rem; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .note-item:hover, .shared-note-item:hover { background-color: var(--bg-body); }
        .note-item.active { background-color: var(--primary-light); border-right: 3px solid var(--primary-color); }
        .note-item h3, .shared-note-item h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.35rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-item p, .shared-note-item p { font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.75rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .note-item-footer, .shared-note-footer { display: flex; justify-content: space-between; align-items: center; }
        .note-date, .shared-note-author { font-size: 0.75rem; color: var(--text-muted); }
        .shared-tag { background-color: #E9D5FF; color: var(--primary-color); font-size: 0.75rem; font-weight: 500; padding: 0.2rem 0.5rem; border-radius: 0.25rem; }

        /* Shared Notes Section */
        .class-notes-section {
            border-top: 1px solid var(--border-color);
            padding: 1rem 0;
        }

        .class-notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 1.5rem;
        }

        .class-notes-header h2 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .class-notes-toggle-icon {
            transition: transform 0.3s ease;
        }

        .class-notes-section.collapsed .class-notes-toggle-icon {
            transform: rotate(-90deg);
        }

        #class-notes-list {
            list-style: none;
            max-height: 300px; /* or any height you prefer */
            overflow-y: auto;
            display: block;
        }

        .class-notes-section.collapsed #class-notes-list {
            display: none;
        }

        .shared-note-item .class-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        .class-color-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Note Editor Panel */
        .note-editor-panel { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #editor-placeholder { text-align: center; padding-top: 20vh; color: var(--text-muted); margin: auto; }
        #editor-placeholder svg { width: 80px; height: 80px; margin-bottom: 1rem; }
        #editor-container { display: none; flex-direction: column; height: 100%; }

        .editor-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .editor-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .save-btn { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .save-btn:hover { background-color: #6D28D9; }
        .save-btn:disabled { background-color: #A78BFA; cursor: not-allowed; }
        .share-btn { background-color: transparent; color: var(--text-light); border: 1px solid var(--border-color); }
        .share-btn:hover { background-color: var(--bg-body); }
        .delete-btn { color: #EF4444; }
        .delete-btn:hover { background-color: #FEE2E2; }
        
        .title-wrapper { padding: 1rem 2rem 0; }
        #note-title-input { width: 100%; border: none; font-size: 2rem; font-weight: 700; padding: 0.5rem 0; background: transparent; outline: none; }
        #note-meta { color: var(--text-muted); font-size: 0.8rem; padding: 0 2rem 0.5rem; }
        
        #quill-editor-container { flex-grow: 1; overflow-y: auto; position: relative; }
        #quill-editor { height: 100%; }
        .ql-container.ql-snow { border: none !important; }
        .ql-editor { font-size: 16px; line-height: 1.7; padding: 1.5rem 2rem; }
        .ql-toolbar.ql-snow { border: none !important; border-bottom: 1px solid var(--border-color) !important; padding: 12px 2rem; }

        #word-count { text-align: right; padding: 0.5rem 2rem; font-size: 0.8rem; color: var(--text-muted); border-top: 1px solid var(--border-color); }
        
        /* Modals & Loaders */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: #fff; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; }
        .modal h2 { margin-bottom: 1.5rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; }
        .modal-btn { padding: 0.6rem 1.2rem; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; }
        #confirm-share-btn { background-color: var(--primary-color); color: #fff; }
        #cancel-share-btn { background-color: var(--border-color); }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <aside class="sidebar">
        <a href="dashboard.html" class="sidebar-header">Academate</a>
        <ul class="nav-menu">
            <li class="nav-item"><a href="dashboard.html"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span>Dasbor</span></a></li>
            <li class="nav-item"><a href="classes.html"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg><span>Kelas</span></a></li>
            <li class="nav-item"><a href="schedule.html"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>Jadwal</span></a></li>
            <li class="nav-item"><a href="notes.html" class="active"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg><span>Catatan</span></a></li>
            <li class="nav-item"><a href="account.html"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span>Akun</span></a></li>
        </ul>
        <button class="logout-button" id="logout-button"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg><span>Keluar</span></button>
    </aside>

    <main class="main-content">
        <div class="notes-list-panel">
            <div class="notes-list-header">
                <h1>Catatan Saya</h1>
                <button class="new-note-btn" id="new-note-btn">Buat Catatan Baru</button>
            </div>
            <div class="search-bar-wrapper">
                <div class="search-bar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                    <input type="text" id="search-input" placeholder="Cari catatan...">
                </div>
            </div>
            <ul id="notes-list">
                <div class="loader"></div>
            </ul>

            <div class="class-notes-section collapsed">
                <div class="class-notes-header">
                    <h2>Catatan Kelas</h2>
                    <svg class="class-notes-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>
                    </svg>
                </div>
                <ul id="class-notes-list">
                    <!-- Shared notes will be populated here by JavaScript -->
                </ul>
            </div>
        </div>
        <div class="note-editor-panel">
             <div id="editor-placeholder">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                <h2>Pilih catatan untuk dilihat atau buat yang baru.</h2>
            </div>
            <div id="editor-container">
                <div class="editor-header">
                    <button class="editor-btn delete-btn" id="delete-note-btn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg><span>Hapus</span></button>
                    <button class="editor-btn share-btn" id="share-note-btn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/></svg><span>Bagikan</span></button>
                    <button class="editor-btn save-btn" id="save-note-btn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 8.036A5.53 5.53 0 0 1 7.583 4h.834a5.53 5.53 0 0 1 5.083 4.036.5.5 0 0 0 .917-.402A6.53 6.53 0 0 0 8.417 3H7.583A6.53 6.53 0 0 0 1.583 7.634a.5.5 0 0 0 .917.402z"/><path d="m9.22 10.323.333 1.665a.5.5 0 0 0 .94.004l1.463-3.657a.5.5 0 0 0-.825-.632l-3.32 2.37a.5.5 0 0 0 .004.94zm-2.48-1.55L4.935 9.14a.5.5 0 0 0-.632.825l2.37 3.32a.5.5 0 0 0 .94-.004l1.665-.333a.5.5 0 0 0 .004-.94l-3.657-1.463z"/></svg><span>Simpan</span></button>
                </div>
                <div class="title-wrapper">
                    <input type="text" id="note-title-input" placeholder="Judul Catatan...">
                </div>
                 <div id="note-meta"></div>
                <div id="quill-editor-container">
                    <div id="quill-editor"></div>
                </div>
                <div id="word-count">0 kata</div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="share-modal">
        <div class="modal">
            <h2>Bagikan Catatan ke Kelas</h2>
            <label for="class-select">Pilih Kelas:</label>
            <select id="class-select"></select>
            <div class="modal-actions">
                <button type="button" class="modal-btn" id="cancel-share-btn">Batal</button>
                <button type="button" class="modal-btn" id="confirm-share-btn">Bagikan</button>
            </div>
        </div>
    </div>
    
    <!-- Quill.js JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, arrayUnion, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyCGr2zchpiAiTn-bMFk-eLNE-1OgGzaSdA",
            authDomain: "acadmte.firebaseapp.com",
            projectId: "acadmte",
            storageBucket: "acadmte.appspot.com",
            messagingSenderId: "547286858993",
            appId: "1:547286858993:web:b83de49e7eb1cc35a67d50",
            measurementId: "G-ZEFYD7F650"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentNoteId = null;
        let notesUnsubscribe = null; 
        let preselectedClassId = null;
        let quill;
        let allNotes = []; // Cache for search
        let sharedNotesUnsubscribes = [];
        let classDataCache = {};
        const classColors = ['#8B5CF6', '#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#EC4899'];


        // --- DOM Elements ---
        const notesListEl = document.getElementById('notes-list');
        const classNotesListEl = document.getElementById('class-notes-list');
        const searchInput = document.getElementById('search-input');
        const newNoteBtn = document.getElementById('new-note-btn');
        const editorPlaceholder = document.getElementById('editor-placeholder');
        const editorContainer = document.getElementById('editor-container');
        const noteTitleInput = document.getElementById('note-title-input');
        const noteMetaEl = document.getElementById('note-meta');
        const wordCountEl = document.getElementById('word-count');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const deleteNoteBtn = document.getElementById('delete-note-btn');
        const shareNoteBtn = document.getElementById('share-note-btn');
        const shareModal = document.getElementById('share-modal');
        const classSelect = document.getElementById('class-select');
        const cancelShareBtn = document.getElementById('cancel-share-btn');
        const confirmShareBtn = document.getElementById('confirm-share-btn');
        const logoutButton = document.getElementById('logout-button');
        const classNotesSection = document.querySelector('.class-notes-section');
        const classNotesHeader = document.querySelector('.class-notes-header');

        // --- Initialize Quill ---
        const toolbarOptions = [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['clean']
        ];
        quill = new Quill('#quill-editor', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Tuliskan catatanmu di sini...',
        });

        // --- Auth & Initial Load ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                checkForRedirect(); 
                listenForNotes(user.uid);
                loadAndListenForSharedNotes(user.uid);
            } else {
                if (notesUnsubscribe) notesUnsubscribe();
                sharedNotesUnsubscribes.forEach(unsub => unsub());
                window.location.replace('auth.html');
            }
        });
        
        // --- Event Listeners ---
        logoutButton.addEventListener('click', () => signOut(auth));
        newNoteBtn.addEventListener('click', handleNewNote);
        searchInput.addEventListener('input', handleSearch);
        classNotesHeader.addEventListener('click', () => {
            classNotesSection.classList.toggle('collapsed');
        });

        function checkForRedirect() {
            const params = new URLSearchParams(window.location.search);
            preselectedClassId = params.get('share_to');
            if(preselectedClassId) {
                window.history.replaceState({}, document.title, window.location.pathname);
                handleNewNote();
            }
        }

        function listenForNotes(userId) {
            const q = query(collection(db, 'users', userId, 'notes'), orderBy('updatedAt', 'desc'));
            notesUnsubscribe = onSnapshot(q, (snapshot) => {
                allNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotesList(allNotes);
            }, (error) => {
                console.error("Error listening for notes:", error);
                notesListEl.innerHTML = '<p class="empty-state">Gagal memuat catatan.</p>';
            });
        }
        
        function renderNotesList(notes) {
            notesListEl.innerHTML = '';
            if (notes.length === 0) {
                notesListEl.innerHTML = '<p style="padding: 1.5rem; text-align: center; color: var(--text-muted);">Belum ada catatan.</p>';
                return;
            }
            notes.forEach(noteData => {
                const li = document.createElement('li');
                li.className = 'note-item';
                li.dataset.id = noteData.id;
                li.dataset.type = 'personal';

                const isShared = noteData.sharedTo && noteData.sharedTo.length > 0;
                
                li.innerHTML = `
                    <h3>${noteData.title || 'Tanpa Judul'}</h3>
                    <p>${noteData.plainText ? noteData.plainText.substring(0, 100) + '...' : 'Tidak ada konten'}</p>
                    <div class="note-item-footer">
                        <span class="note-date">${noteData.updatedAt ? noteData.updatedAt.toDate().toLocaleDateString('id-ID') : ''}</span>
                        ${isShared ? '<span class="shared-tag">Dibagikan</span>' : ''}
                    </div>
                `;
                li.addEventListener('click', () => handleNoteSelect(noteData.id, 'personal'));
                notesListEl.appendChild(li);
            });
             if (currentNoteId) {
                const activeItem = notesListEl.querySelector(`[data-id="${currentNoteId}"]`);
                if (activeItem) activeItem.classList.add('active');
            }
        }
        
        async function loadAndListenForSharedNotes(userId) {
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (!userDoc.exists()) return;

            const joinedClasses = userDoc.data().joinedClasses || [];
            if (joinedClasses.length === 0) {
                classNotesListEl.innerHTML = '<p style="padding: 1.5rem; text-align: center; color: var(--text-muted);">Gabung kelas untuk melihat catatan bersama.</p>';
                return;
            }
            
            const classDocs = await Promise.all(joinedClasses.map(id => getDoc(doc(db, 'classes', id))));
            classDocs.forEach((classDoc, index) => {
                if(classDoc.exists()) {
                    classDataCache[classDoc.id] = { ...classDoc.data(), color: classColors[index % classColors.length] };
                }
            });


            sharedNotesUnsubscribes.forEach(unsub => unsub()); // Unsubscribe from previous listeners
            sharedNotesUnsubscribes = [];

            let allSharedNotes = [];

            joinedClasses.forEach(classId => {
                const q = query(collection(db, 'classes', classId, 'sharedNotes'), orderBy('sharedAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const classNotes = snapshot.docs.map(d => ({
                        id: d.id,
                        classId: classId,
                        ...d.data()
                    }));

                    allSharedNotes = allSharedNotes.filter(note => note.classId !== classId).concat(classNotes);
                    allSharedNotes.sort((a, b) => b.sharedAt.toMillis() - a.sharedAt.toMillis());

                    renderSharedNotes(allSharedNotes);
                });
                sharedNotesUnsubscribes.push(unsubscribe);
            });
        }

        function renderSharedNotes(notes) {
            classNotesListEl.innerHTML = '';
             if (notes.length === 0) {
                classNotesListEl.innerHTML = '<p style="padding: 1.5rem; text-align: center; color: var(--text-muted);">Belum ada catatan dibagikan di kelas Anda.</p>';
                return;
            }

            notes.forEach(noteData => {
                const classInfo = classDataCache[noteData.classId];
                if(!classInfo) return;

                const li = document.createElement('li');
                li.className = 'shared-note-item';
                li.dataset.id = noteData.id;
                li.dataset.classId = noteData.classId;
                li.dataset.type = 'shared';
                
                li.innerHTML = `
                    <h3>${noteData.title || 'Tanpa Judul'}</h3>
                    <p>${noteData.body ? noteData.body.substring(0, 100) + '...' : 'Tidak ada konten'}</p>
                    <div class="shared-note-footer">
                        <span class="shared-note-author">Oleh: ${noteData.sharedBy}</span>
                    </div>
                     <div class="class-info">
                        <span class="class-color-dot" style="background-color: ${classInfo.color};"></span>
                        <span>${classInfo.namaMataKuliah}</span>
                    </div>
                `;

                li.addEventListener('click', () => handleNoteSelect(noteData.id, 'shared', noteData.classId));
                classNotesListEl.appendChild(li);
            });
        }


        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredNotes = allNotes.filter(note => 
                note.title.toLowerCase().includes(searchTerm) || 
                (note.plainText && note.plainText.toLowerCase().includes(searchTerm))
            );
            renderNotesList(filteredNotes);
        }
        
        async function handleNoteSelect(noteId, type, classId = null) {
            currentNoteId = noteId;

            if (type === 'personal') {
                const noteData = allNotes.find(n => n.id === noteId);
                if (!noteData) return;

                noteTitleInput.value = noteData.title;
                try {
                    const content = JSON.parse(noteData.contentDelta || '[]');
                    quill.setContents(content);
                } catch (e) {
                    quill.setText('Gagal memuat konten catatan.');
                }
                noteMetaEl.textContent = `Terakhir diperbarui: ${noteData.updatedAt.toDate().toLocaleString('id-ID')}`;
                
                // Show personal note edit controls
                ['save-note-btn', 'delete-note-btn', 'share-note-btn'].forEach(id => document.getElementById(id).style.display = 'flex');
                noteTitleInput.readOnly = false;
                quill.enable();

            } else if (type === 'shared') {
                const noteRef = doc(db, 'classes', classId, 'sharedNotes', noteId);
                const noteSnap = await getDoc(noteRef);
                if (!noteSnap.exists()) return;
                const noteData = noteSnap.data();

                noteTitleInput.value = noteData.title;
                quill.setText(noteData.body);
                noteMetaEl.textContent = `Dibagikan oleh ${noteData.sharedBy} pada ${noteData.sharedAt.toDate().toLocaleString('id-ID')}`;
                
                // Hide edit controls for shared notes
                ['save-note-btn', 'delete-note-btn', 'share-note-btn'].forEach(id => document.getElementById(id).style.display = 'none');
                noteTitleInput.readOnly = true;
                quill.disable();
            }

            updateWordCount();

            editorPlaceholder.style.display = 'none';
            editorContainer.style.display = 'flex';
            
            document.querySelectorAll('.note-item, .shared-note-item').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`[data-id="${noteId}"][data-type="${type}"]`);
            if (activeItem) activeItem.classList.add('active');
        }

        
        function handleNewNote() {
            currentNoteId = null;
            noteTitleInput.value = '';
            quill.setContents([]);
            noteMetaEl.textContent = 'Catatan baru';
            updateWordCount();

            editorPlaceholder.style.display = 'none';
            editorContainer.style.display = 'flex';
            noteTitleInput.focus();
            document.querySelectorAll('.note-item').forEach(item => item.classList.remove('active'));
            
            ['save-note-btn', 'delete-note-btn', 'share-note-btn'].forEach(id => document.getElementById(id).style.display = 'flex');
            noteTitleInput.readOnly = false;
            quill.enable();
        }

        // Quill word counter
        quill.on('text-change', () => updateWordCount());
        function updateWordCount() {
            const text = quill.getText().trim();
            const wordCount = text.length > 0 ? text.split(/\s+/).length : 0;
            wordCountEl.textContent = `${wordCount} kata`;
        }
        
        // --- CRUD Operations ---
        saveNoteBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            
            const title = noteTitleInput.value.trim();
            const contentDelta = quill.getContents();
            const plainText = quill.getText();

            if (!title && plainText.trim().length === 0) {
                alert("Catatan tidak boleh kosong.");
                return;
            }

            saveNoteBtn.disabled = true;
            saveNoteBtn.textContent = 'Menyimpan...';

            try {
                const noteData = {
                    title: title || 'Tanpa Judul',
                    contentDelta: JSON.stringify(contentDelta),
                    plainText: plainText,
                    updatedAt: serverTimestamp()
                };

                const isNewNote = !currentNoteId;
                if (isNewNote) {
                    noteData.createdAt = serverTimestamp();
                    const newDocRef = await addDoc(collection(db, 'users', currentUser.uid, 'notes'), noteData);
                    currentNoteId = newDocRef.id;
                } else {
                    await updateDoc(doc(db, 'users', currentUser.uid, 'notes', currentNoteId), noteData);
                }
                noteMetaEl.textContent = `Tersimpan pada ${new Date().toLocaleTimeString('id-ID')}`;

                if (isNewNote && preselectedClassId) {
                    shareNoteBtn.click();
                }

            } catch (error) {
                console.error("Error saving note: ", error);
                alert("Gagal menyimpan catatan.");
            } finally {
                saveNoteBtn.disabled = false;
                saveNoteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 8.036A5.53 5.53 0 0 1 7.583 4h.834a5.53 5.53 0 0 1 5.083 4.036.5.5 0 0 0 .917-.402A6.53 6.53 0 0 0 8.417 3H7.583A6.53 6.53 0 0 0 1.583 7.634a.5.5 0 0 0 .917.402z"/><path d="m9.22 10.323.333 1.665a.5.5 0 0 0 .94.004l1.463-3.657a.5.5 0 0 0-.825-.632l-3.32 2.37a.5.5 0 0 0 .004.94zm-2.48-1.55L4.935 9.14a.5.5 0 0 0-.632.825l2.37 3.32a.5.5 0 0 0 .94-.004l1.665-.333a.5.5 0 0 0 .004-.94l-3.657-1.463z"/></svg><span>Simpan</span>`;
            }
        });

        deleteNoteBtn.addEventListener('click', async () => {
            if (!currentNoteId || !currentUser || !confirm("Apakah Anda yakin ingin menghapus catatan ini?")) return;
            
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'notes', currentNoteId));
                currentNoteId = null;
                editorContainer.style.display = 'none';
                editorPlaceholder.style.display = 'block';
            } catch (error) {
                console.error("Error deleting note: ", error);
                alert("Gagal menghapus catatan.");
            }
        });

        // --- Share Functionality ---
        shareNoteBtn.addEventListener('click', async () => {
            if (!currentNoteId || !currentUser) {
                alert("Silakan simpan catatan terlebih dahulu sebelum membagikannya.");
                return;
            }
            shareModal.style.display = 'flex';
            classSelect.innerHTML = '<option>Memuat kelas...</option>';
            
            try {
                const userDocSnap = await getDoc(doc(db, 'users', currentUser.uid));
                const joinedClassesIds = userDocSnap.data().joinedClasses || [];
                if (joinedClassesIds.length === 0) {
                    classSelect.innerHTML = '<option>Anda belum gabung kelas</option>';
                    return;
                }

                const classPromises = joinedClassesIds.map(id => getDoc(doc(db, 'classes', id)));
                const classSnapshots = await Promise.all(classPromises);
                
                classSelect.innerHTML = '';
                classSnapshots.forEach(snap => {
                    if (snap.exists()) {
                        classSelect.innerHTML += `<option value="${snap.id}">${snap.data().namaMataKuliah}</option>`;
                    }
                });
                
                if (preselectedClassId) {
                    classSelect.value = preselectedClassId;
                }
            } catch (error) {
                console.error("Error loading classes for sharing:", error);
                classSelect.innerHTML = '<option>Gagal memuat kelas</option>';
            }
        });

        cancelShareBtn.addEventListener('click', () => {
            shareModal.style.display = 'none';
            preselectedClassId = null;
        });
        
        confirmShareBtn.addEventListener('click', async () => {
            const selectedClassId = classSelect.value;
            if (!selectedClassId || !currentNoteId || !currentUser) return;
            
            confirmShareBtn.disabled = true;
            confirmShareBtn.textContent = "Membagikan...";

            try {
                const noteRef = doc(db, 'users', currentUser.uid, 'notes', currentNoteId);
                const noteSnap = await getDoc(noteRef);
                
                if (noteSnap.exists()) {
                    const noteData = noteSnap.data();
                    const sharedNotePayload = {
                        originalNoteId: currentNoteId,
                        originalOwnerId: currentUser.uid,
                        title: noteData.title,
                        body: noteData.plainText,
                        sharedBy: currentUser.displayName || 'Anonymous',
                        sharedByPhotoURL: currentUser.photoURL || null,
                        sharedAt: serverTimestamp()
                    };

                    await addDoc(collection(db, 'classes', selectedClassId, 'sharedNotes'), sharedNotePayload);
                    
                    // Mark note as shared
                    await updateDoc(noteRef, {
                        sharedTo: arrayUnion(selectedClassId)
                    });
                    
                    alert("Catatan berhasil dibagikan!");
                    shareModal.style.display = 'none';
                    preselectedClassId = null;
                }
            } catch (error) {
                console.error("Error sharing note:", error);
                alert("Gagal membagikan catatan.");
            } finally {
                confirmShareBtn.disabled = false;
                confirmShareBtn.textContent = "Bagikan";
            }
        });
    </script>
</body>
</html>
