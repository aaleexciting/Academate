<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tugas â€” Academate</title>

  <!-- Fonts & Icons (match dashboard/classes) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css">

  <style>
    :root{
      --bg:#F7F7FA;--surface:#fff;--text:#1E1F24;--muted:#6C6F7F;--primary:#6F6CFF;--primary-2:#8B7CFF;--border:#ECECF1;--shadow:0 6px 24px rgba(30,31,36,.07);--radius:18px;--sidebar-w:280px;--content-max:1320px;--gap:18px;
      --success:#10B981;--warn:#F59E0B;--danger:#EF4444;--info:#3B82F6;
    }
    html,body{height:100%}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;font-size:15px;padding-bottom:80px}
    a{color:inherit}

    /* App Shell */
    .app{padding:var(--gap);width:100%;max-width:1700px;margin:0 auto;min-height:100dvh}
    .main{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .main-content{padding:var(--gap);width:100%}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--surface);cursor:pointer;font-weight:600;text-decoration:none;transition:.2s}
    .btn:hover{border-color:#d8d8e0}
    .btn-primary{background:var(--primary);color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(111,108,255,.28)}
    .btn-primary:hover{filter:brightness(.98)}
    .btn-secondary{background:#F3F2FF;color:var(--primary);border-color:#E7E6FF}
    .icon-btn{width:42px;height:42px;border-radius:50%;border:1px solid var(--border);background:var(--surface);display:grid;place-items:center;cursor:pointer;color:var(--muted);font-size:20px;transition:.2s;flex-shrink:0}
    .icon-btn:hover{color:var(--primary);border-color:#d8d8e0}

    /* Header */
    .header{margin-top:var(--gap);margin-bottom:24px}
    .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .header-brand{font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--primary-2));-webkit-background-clip:text;background-clip:text;color:transparent;display:inline-block}
    .header-actions{display:flex;gap:8px}
    .header-actions .icon-btn{width:38px;height:38px;font-size:18px}
    .header-main{display:flex;justify-content:space-between;align-items:center;gap:16px}
    .header-main h1{font-size:22px;margin:0}
    .header-main p{color:var(--muted);margin:4px 0 0;font-size:14px}
    .header-avatar-link{text-decoration:none}
    .header-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0}
    .header-toolbar{display:none}

    /* Mobile nav */
    .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;justify-content:space-around;align-items:center;height:70px;padding:0 10px;z-index:1000}
    .mobile-nav a{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);text-decoration:none;font-size:10px;font-weight:500;padding:8px;border-radius:8px}
    .mobile-nav a i{font-size:20px}
    .mobile-nav a.active{color:var(--primary)}

    /* Responsive layout */
    .sidebar{display:none}
    .page-grid{display:flex;flex-direction:column;gap:var(--gap)}

    /* Desktop */
    @media (min-width:901px){
      body{padding-bottom:0}
      .mobile-nav{display:none}
      .app{display:grid;grid-template-columns:var(--sidebar-w) minmax(0,1fr);gap:24px}

      .sidebar{display:flex;flex-direction:column;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px}
      .brand{display:flex;align-items:center;gap:12px;font-weight:700;font-size:22px;margin-bottom:18px}
      .brand .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#8B7CFF,#6AC9FF)}
      .nav{display:flex;flex-direction:column;gap:8px;overflow:auto;padding-right:2px}
      .nav a{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;color:var(--muted);text-decoration:none;font-weight:500;transition:.2s}
      .nav a i{font-size:20px}
      .nav a:hover{background:#F3F2FF;color:var(--primary)}
      .nav a.active{background:var(--primary);color:#fff;box-shadow:0 8px 20px rgba(111,108,255,.3)}
      .spacer{flex:1}
      .sidebar-footer{margin-top:auto;padding-top:16px;border-top:1px solid var(--border)}
      .sidebar-logout-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:12px;border-radius:12px;background:transparent;border:1px solid var(--border);color:var(--muted);font-weight:600;cursor:pointer;transition:.2s}
      .sidebar-logout-btn:hover{background:#fde2e2;border-color:#f7b2b2;color:#c82424}
      .sidebar-links{text-align:center;margin-top:16px;display:flex;justify-content:center;gap:16px}
      .sidebar-links a{font-size:12px;color:var(--muted);text-decoration:none}
      .sidebar-links a:hover{text-decoration:underline}
      .copyright{font-size:11px;color:#C0C3D2;text-align:center;margin-top:12px}

      .main-content{max-width:min(var(--content-max),calc(100vw - var(--sidebar-w) - 120px));margin:0 auto}

      .header{display:flex;justify-content:space-between;align-items:center}
      .header-top,.header-avatar-link,.header-actions{display:none}
      .header-main{display:block}
      .header-main h1{font-size:26px}
      .header-main p{font-size:15px;margin-top:6px}
      .header-toolbar{display:flex;align-items:center;gap:12px}
      .search-bar{position:relative}
      .search-bar input{width:320px;padding:12px 16px 12px 44px;border-radius:12px;border:1px solid var(--border);background:var(--bg);outline:none;transition:.2s}
      .search-bar input:focus{border-color:var(--primary);background:var(--surface)}
      .search-bar i{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--muted)}
    }

    /* === Task page components === */
    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .tabs{display:flex;border:1px solid var(--border);border-radius:12px;background:var(--surface);padding:4px}
    .tab-btn{padding:8px 14px;border:none;background:none;border-radius:10px;font-weight:600;color:var(--muted);cursor:pointer}
    .tab-btn.active{background:#F3F2FF;color:var(--primary)}
    .filters{display:flex;gap:10px;flex-wrap:wrap}
    .filters select{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--surface);font-weight:600}

    .task-list{display:grid;gap:12px}
    .task-item{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;transition:transform .18s ease, box-shadow .18s ease}
    .task-item:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,.06)}
    .task-row{display:flex;align-items:center;gap:12px;padding:14px}
    .task-icon{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;background:#F3F2FF;color:var(--primary)}
    .task-main{flex:1}
    .task-main h4{margin:0;font-size:15px}
    .task-main p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .task-meta{display:flex;align-items:center;gap:10px}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .checkbox{width:24px;height:24px;border:2px solid var(--border);border-radius:8px;display:grid;place-items:center;cursor:pointer}
    .task-item.done{opacity:.85}
    .task-item.done .checkbox{background:var(--success);border-color:var(--success);color:#fff}
    .expand{color:var(--muted);cursor:pointer}
    .details{max-height:0;overflow:hidden;transition:max-height .25s ease,padding .25s ease}
    .task-item.expanded .details{max-height:320px;padding:0 14px 14px}

    .empty{ text-align:center; padding:40px; border:2px dashed var(--border); border-radius:14px; background:var(--surface); color:var(--muted) }
    .loader{ border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; margin: 60px auto; }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    /* Modal */
    .modal-overlay{ position:fixed; inset:0; background: rgba(17, 24, 39, .55); backdrop-filter: blur(4px); display:none; align-items:center; justify-content:center; z-index:1000 }
    .modal{ background:#fff; width:90%; max-width:560px; border-radius:16px; padding:20px; box-shadow:var(--shadow) }
    .modal h2{ margin:0 0 4px; font-size:18px }
    .modal .sub{ color:var(--muted); margin-bottom:14px; font-size:13px }
    .modal-form{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .form-group{ display:flex; flex-direction:column }
    .form-group label{ font-weight:600; font-size:13px; margin-bottom:6px }
    .form-group input, .form-group select, .form-group textarea{ padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--surface); outline:none }
    .form-group textarea{ min-height:90px; resize:vertical }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus{ border-color:var(--primary) }
    .full{ grid-column:1 / -1 }
    .modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; grid-column:1 / -1 }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigasi utama">
      <div class="brand"><div class="logo" aria-hidden="true"></div>Academate</div>
      <nav class="nav">
        <a href="dashboard.html"><i class="ri-dashboard-2-line"></i><span>Dasbor</span></a>
        <a href="classes.html"><i class="ri-book-open-line"></i><span>Kelas</span></a>
        <a class="active" href="task.html"><i class="ri-task-line"></i><span>Tugas</span></a>
        <a href="schedule.html"><i class="ri-calendar-2-line"></i><span>Jadwal</span></a>
        <a href="notes.html"><i class="ri-file-list-3-line"></i><span>Catatan</span></a>
        <a href="account.html"><i class="ri-user-3-line"></i><span>Akun</span></a>
      </nav>
      <div class="spacer"></div>
      <div class="sidebar-footer">
        <button id="logout-button-desktop" class="sidebar-logout-btn" type="button" title="Keluar"><i class="ri-logout-box-r-line"></i><span>Keluar</span></button>
        <div class="sidebar-links"><a href="#">Terms of Service</a><a href="#">Privacy Policy</a></div>
        <p class="copyright">&copy; 2025 Academate</p>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="main-content">
        <header class="header">
          <div class="header-top">
            <div class="header-brand">Academate</div>
            <div class="header-actions">
              <button class="icon-btn" title="Cari"><i class="ri-search-line"></i></button>
              <button class="icon-btn" title="Notifikasi"><i class="ri-notification-3-line"></i></button>
            </div>
          </div>
          <div class="header-main">
            <div>
              <h1>Tugas</h1>
              <p>Semua tugas dari semua kelas Andaâ€”selaras dengan dasbor & kelas.</p>
            </div>
            <a href="account.html" class="header-avatar-link"><img id="header-avatar-img" class="header-avatar" alt="Foto profil"></a>
          </div>
          <div class="header-toolbar">
            <div class="search-bar">
              <i class="ri-search-line"></i>
              <input id="global-search" type="text" placeholder="Cari tugas, kelas, deskripsi...">
            </div>
            <button class="icon-btn" id="open-create-modal" title="Buat Tugas"><i class="ri-add-line"></i></button>
          </div>
        </header>

        <div class="page-grid">
          <section class="card">
            <div class="toolbar">
              <div class="tabs">
                <button class="tab-btn active" data-tab="active">Aktif</button>
                <button class="tab-btn" data-tab="completed">Selesai</button>
              </div>
              <div class="filters">
                <select id="class-filter"><option value="all">Semua Kelas</option></select>
                <select id="sort-filter">
                  <option value="due-date-asc">Tenggat Terdekat</option>
                  <option value="due-date-desc">Tenggat Terjauh</option>
                  <option value="class-name">Nama Kelas</option>
                </select>
              </div>
            </div>
          </section>

          <section class="card" aria-live="polite">
            <div id="list-active" class="task-list"></div>
            <div id="list-completed" class="task-list" style="display:none"></div>
            <div id="loading" class="loader" role="status" aria-label="Memuat tugas..."></div>
            <div id="empty" class="empty" style="display:none">Tidak ada tugas di sini. Santai dulu ðŸ˜Ž</div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Nav -->
  <nav class="mobile-nav">
    <a href="dashboard.html"><i class="ri-dashboard-2-line"></i><span>Dasbor</span></a>
    <a href="classes.html"><i class="ri-book-open-line"></i><span>Kelas</span></a>
    <a class="active" href="task.html"><i class="ri-task-line"></i><span>Tugas</span></a>
    <a href="schedule.html"><i class="ri-calendar-2-line"></i><span>Jadwal</span></a>
    <a href="notes.html"><i class="ri-file-list-3-line"></i><span>Catatan</span></a>
  </nav>

  <!-- Create Task Modal (optional, non-destructive) -->
  <div class="modal-overlay" id="create-task-modal">
    <div class="modal">
      <h2>Buat Tugas</h2>
      <p class="sub">Tambahkan tugas baru ke salah satu kelas Anda.</p>
      <form id="create-task-form" class="modal-form">
        <div class="form-group full"><label for="task-title">Judul</label><input id="task-title" required></div>
        <div class="form-group full"><label for="task-class">Kelas</label><select id="task-class" required></select></div>
        <div class="form-group"><label for="task-date">Tenggat</label><input id="task-date" type="date" required></div>
        <div class="form-group"><label for="task-time">Waktu</label><input id="task-time" type="time" value="23:59"></div>
        <div class="form-group full"><label for="task-desc">Deskripsi</label><textarea id="task-desc" placeholder="Opsional"></textarea></div>
        <div class="modal-actions"><button type="button" class="btn" id="cancel-create">Batal</button><button type="submit" class="btn btn-primary">Simpan</button></div>
      </form>
    </div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, addDoc, query, where, updateDoc, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCGr2zchpiAiTn-bMFk-eLNE-1OgGzaSdA", authDomain: "acadmte.firebaseapp.com", projectId: "acadmte", storageBucket: "acadmte.appspot.com", messagingSenderId: "547286858993", appId: "1:547286858993:web:b83de49e7eb1cc35a67d50", measurementId: "G-ZEFYD7F650" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null; let classes = []; let classMap = {}; let tasks = [];

    // UI refs
    const listActive = document.getElementById('list-active');
    const listCompleted = document.getElementById('list-completed');
    const loading = document.getElementById('loading');
    const emptyEl = document.getElementById('empty');

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ window.location.replace('auth.html'); return; }
      currentUser = user;
      hydrateAvatar();
      await hydrateClasses();
      await hydrateTasks();
      renderAll();
      attachEvents();
    });

    function hydrateAvatar(){
      const avatar = document.getElementById('header-avatar-img');
      const name = localStorage.getItem('userDisplayName') || (currentUser?.displayName ?? 'A');
      const photo = localStorage.getItem('userPhotoURL') || currentUser?.photoURL;
      if (avatar) avatar.src = photo || `https://placehold.co/80x80/E5E7EB/6B7280?text=${(name||'A').charAt(0)}`;
    }

    async function hydrateClasses(){
      const userDoc = await getDoc(doc(db,'users', currentUser.uid));
      const ids = userDoc.exists()? (userDoc.data().joinedClasses || []) : [];
      if(!ids.length){ loading.style.display='none'; emptyEl.style.display='block'; return; }
      const snaps = await Promise.all(ids.map(id => getDoc(doc(db,'classes',id))));
      classes = snaps.filter(s=>s.exists()).map(s=>({ id:s.id, ...s.data() }));
      classMap = Object.fromEntries(classes.map(c=>[c.id,c]));
      // fill filters & modal select
      const classFilter = document.getElementById('class-filter');
      classFilter.innerHTML = `<option value="all">Semua Kelas</option>` + classes.map(c=>`<option value="${c.id}">${escapeHTML(c.namaMataKuliah||'Kelas')}</option>`).join('');
      const select = document.getElementById('task-class');
      select.innerHTML = classes.map(c=>`<option value="${c.id}">${escapeHTML(c.namaMataKuliah||'Kelas')}</option>`).join('');
    }

    async function hydrateTasks(){
      loading.style.display='block'; emptyEl.style.display='none'; listActive.innerHTML=''; listCompleted.innerHTML='';
      tasks = [];
      // Pull tasks from subcollections: classes/{id}/tasks (preserve your current schema)
      for(const c of classes){
        const snap = await getDocs(collection(db,'classes',c.id,'tasks'));
        snap.forEach(d => tasks.push({ id:d.id, classId:c.id, ...d.data() }));
      }
      // Optional: also merge from any top-level 'tasks' that reference classId (if your schema mixes)
      try{
        const qy = query(collection(db,'tasks'), where('classId','!=', null));
        const top = await getDocs(qy);
        top.forEach(d=>{ const t=d.data(); if(!tasks.some(x=>x.id===d.id)) tasks.push({ id:d.id, ...t }); });
      }catch{ /* ignore if collection doesn't exist */ }
      loading.style.display='none';
      if(!tasks.length) emptyEl.style.display='block';
    }

    function renderAll(){
      const classFilter = document.getElementById('class-filter').value;
      const sortFilter = document.getElementById('sort-filter').value;
      const q = (document.getElementById('global-search')?.value||'').toLowerCase();

      let list = classFilter==='all'? tasks : tasks.filter(t=> t.classId===classFilter);
      // search
      list = list.filter(t=> (t.title||'').toLowerCase().includes(q) || (classMap[t.classId]?.namaMataKuliah||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q));

      // sort
      list.sort((a,b)=>{
        if(sortFilter==='class-name'){
          return (classMap[a.classId]?.namaMataKuliah||'').localeCompare(classMap[b.classId]?.namaMataKuliah||'');
        }
        const aSec = tsSec(a.dueDate); const bSec = tsSec(b.dueDate);
        return sortFilter==='due-date-desc' ? (bSec-aSec) : (aSec-bSec);
      });

      const mineIsDone = (t)=> (t.completedBy?.some(c => (typeof c==='object'? c.uid : c) === currentUser.uid));
      const active = list.filter(t=> !mineIsDone(t));
      const done = list.filter(t=> mineIsDone(t));

      renderList(listActive, active);
      renderList(listCompleted, done);

      emptyEl.style.display = (active.length===0 && document.querySelector('.tab-btn.active')?.dataset.tab==='active') || (done.length===0 && document.querySelector('.tab-btn.active')?.dataset.tab==='completed') ? 'block':'none';
    }

    function renderList(container, arr){
      container.innerHTML='';
      arr.forEach(t=> container.appendChild(buildTaskItem(t)));
    }

    function buildTaskItem(task){
      const isDone = task.completedBy?.some(c => (typeof c==='object'? c.uid : c) === currentUser.uid);
      const due = formatDue(task.dueDate);
      const el = document.createElement('div');
      el.className = `task-item ${isDone?'done':''}`;
      el.innerHTML = `
        <div class="task-row">
          <div class="task-icon"><i class="ri-clipboard-line"></i></div>
          <div class="task-main">
            <h4>${escapeHTML(task.title||'Tanpa judul')}</h4>
            <p>${escapeHTML(classMap[task.classId]?.namaMataKuliah || 'Kelas')}</p>
          </div>
          <div class="task-meta">
            <span class="chip"><i class="ri-time-line"></i>${due.text}</span>
            <span class="checkbox" data-id="${task.id}" data-class="${task.classId}">${isDone?'<i class="ri-check-line"></i>':''}</span>
            ${task.description?'<span class="expand"><i class="ri-arrow-down-s-line"></i></span>':''}
          </div>
        </div>
        ${task.description? `<div class="details"><p style="color:var(--muted);margin:0 0 4px">${escapeHTML(task.description).replace(/\n/g,'<br>')}</p></div>`:''}
      `;
      el.addEventListener('click', (e)=>{
        const box = e.target.closest('.checkbox');
        if(box){ toggleTask(box.dataset.id, box.dataset.class); return; }
        if(e.target.closest('.expand')) el.classList.toggle('expanded');
      });
      return el;
    }

    async function toggleTask(taskId, classId){
      // prefer subcollection doc; fallback to top-level if not found
      let refPath = ['classes', classId, 'tasks', taskId];
      let inTop = false;
      try{ // quick check if top-level exists
        // no direct exists check; assume subcollection
      }catch{}
      const t = tasks.find(x=> x.id===taskId && (x.classId===classId || !x.classId));
      const wasDone = t?.completedBy?.some(c => (typeof c==='object'? c.uid : c) === currentUser.uid);
      try{
        const { doc:mkdoc, updateDoc:upd, arrayUnion:au, arrayRemove:ar } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const dref = mkdoc(db, ...refPath);
        if(wasDone){ await upd(dref, { completedBy: ar(currentUser.uid) }); if(t){ t.completedBy = (t.completedBy||[]).filter(x=> (typeof x==='object'? x.uid : x) !== currentUser.uid); }
        } else { await upd(dref, { completedBy: au(currentUser.uid) }); if(t){ (t.completedBy||(t.completedBy=[])).push(currentUser.uid); } }
        // also mirror to any top-level 'tasks' doc with same id (best-effort)
        if(inTop){ /* no-op placeholder */ }
        renderAll();
        // Optionally update class cached counters here if you store them
      }catch(err){ console.error(err); alert('Gagal memperbarui tugas.'); }
    }

    // Create task
    document.getElementById('open-create-modal').addEventListener('click', ()=> toggleModal('create-task-modal', true));
    document.getElementById('cancel-create').addEventListener('click', ()=> toggleModal('create-task-modal', false));
    document.getElementById('create-task-form').addEventListener('submit', createTask);

    async function createTask(e){
      e.preventDefault();
      const title = document.getElementById('task-title').value.trim();
      const classId = document.getElementById('task-class').value;
      const date = document.getElementById('task-date').value;
      const time = document.getElementById('task-time').value || '23:59';
      const desc = document.getElementById('task-desc').value.trim();
      if(!title || !classId || !date){ return; }
      const dueTimestamp = new Date(`${date}T${time}:00`);
      try{
        const col = collection(db,'classes',classId,'tasks');
        const newDoc = await addDoc(col, { title, classId, description: desc, dueDate: { seconds: Math.floor(dueTimestamp.getTime()/1000), nanoseconds: 0 }, completedBy: [], createdAt: serverTimestamp() });
        toggleModal('create-task-modal', false);
        await hydrateTasks(); renderAll();
      }catch(err){ console.error(err); alert('Gagal membuat tugas.'); }
    }

    function attachEvents(){
      document.getElementById('logout-button-desktop')?.addEventListener('click', ()=> signOut(auth));
      document.getElementById('class-filter').addEventListener('change', renderAll);
      document.getElementById('sort-filter').addEventListener('change', renderAll);
      document.querySelector('.tabs').addEventListener('click', (e)=>{
        if(!e.target.classList.contains('tab-btn')) return;
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        const isActive = e.target.dataset.tab==='active';
        document.getElementById('list-active').style.display = isActive?'grid':'none';
        document.getElementById('list-completed').style.display = isActive?'none':'grid';
        renderAll();
      });
      document.getElementById('global-search')?.addEventListener('input', renderAll);
      document.querySelectorAll('.modal-overlay').forEach(ov=> ov.addEventListener('click', (e)=>{ if(e.target===ov) ov.style.display='none'; }));
    }

    function toggleModal(id, show){ const el = document.getElementById(id); if(!el) return; el.style.display = show ? 'flex' : 'none'; }

    function tsSec(d){ try{ return d?.seconds ?? Math.floor((d?.toDate?.()||new Date(d)).getTime()/1000); }catch{ return 0 } }
    function formatDue(d){
      const sec = tsSec(d); if(!sec) return { text: 'â€”' };
      const today = new Date(); today.setHours(0,0,0,0);
      const due = new Date(sec*1000); due.setHours(0,0,0,0);
      const diff = Math.ceil((due - today) / 86400000);
      if(diff<0) return { text:'Telah lewat' };
      if(diff===0) return { text:'Hari ini' };
      if(diff===1) return { text:'Besok' };
      if(diff<=7) return { text:`${diff} hari lagi` };
      return { text: due.toLocaleDateString('id-ID',{day:'numeric',month:'short'}) };
    }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }
  </script>
</body>
</html>