<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jadwal â€” Academate</title>

  <!-- Fonts & Icons (Consistent with other pages) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css">

  <style>
    /* === Global Styles (from other pages) === */
    :root{
      --bg:#F7F7FA;--surface:#fff;--text:#1E1F24;--muted:#6C6F7F;--primary:#6F6CFF;--primary-2:#8B7CFF;--border:#ECECF1;--shadow:0 6px 24px rgba(30,31,36,.07);--radius:18px;--sidebar-w:280px;--content-max:1320px;--gap:18px;
      --danger:#EF4444;
      --hour-height: 60px; /* Specific to schedule */
    }
    html,body{height:100%}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;font-size:15px;padding-bottom:80px}
    a{color:inherit; text-decoration: none;}

    /* === App Shell (from other pages) === */
    .app{padding:var(--gap);width:100%;max-width:1700px;margin:0 auto;min-height:100dvh}
    .main{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .main-content{padding:var(--gap);width:100%; height: 100%; display: flex; flex-direction: column;}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--surface);cursor:pointer;font-weight:600;text-decoration:none;transition:.2s}
    .btn:hover{border-color:#d8d8e0}
    .btn-primary{background:var(--primary);color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(111,108,255,.28)}
    .btn-primary:hover{filter:brightness(.98)}
    .icon-btn{width:42px;height:42px;border-radius:50%;border:1px solid var(--border);background:var(--surface);display:grid;place-items:center;cursor:pointer;color:var(--muted);font-size:20px;transition:.2s;flex-shrink:0}
    .icon-btn:hover{color:var(--primary);border-color:#d8d8e0}

    /* Header */
    .header{margin-top:var(--gap);margin-bottom:24px}
    .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .header-brand{font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--primary-2));-webkit-background-clip:text;background-clip:text;color:transparent;display:inline-block}
    .header-actions{display:flex;gap:8px}
    .header-actions .icon-btn{width:38px;height:38px;font-size:18px}
    .header-main{display:flex;justify-content:space-between;align-items:center;gap:16px}
    .header-main h1{font-size:22px;margin:0}
    .header-main p{color:var(--muted);margin:4px 0 0;font-size:14px}
    .header-avatar-link{text-decoration:none}
    .header-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0}
    .header-toolbar{display:none}

    /* Mobile nav */
    .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;justify-content:space-around;align-items:center;height:70px;padding:0 10px;z-index:1000}
    .mobile-nav a{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);text-decoration:none;font-size:10px;font-weight:500;padding:8px;border-radius:8px}
    .mobile-nav a i{font-size:20px}
    .mobile-nav a.active{color:var(--primary)}

    /* Responsive layout */
    .sidebar{display:none}
    
    /* === NEW MOBILE SCROLLING IMPLEMENTATION (Corrected) === */
    @media (max-width: 900px) {
      body { overflow-y: auto; }
      .app { height: auto; padding-bottom: 80px; }
      .main { height: auto; }
      .main-content { height: auto; }
      .calendar-wrapper { height: auto; min-height: 70vh; }

      .calendar-header, .calendar-body {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
      }
      .calendar-header::-webkit-scrollbar, .calendar-body::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Chrome, Safari and Opera */
      }
      
      /* Make header scrollable and override desktop grid */
      .calendar-header {
         display: block;
         overflow-x: auto;
         white-space: nowrap;
         padding: 8px 0;
         position: relative;
      }
      /* This wrapper is for scroll syncing */
      .header-scroll-wrapper {
        display: flex;
        padding-left: 60px; /* Align with sticky time column */
      }
      .calendar-header .day-name {
        flex: 0 0 110px; /* Give days a fixed width so they don't squish */
      }
       .calendar-header > div:first-child {
         display: none; /* Hide desktop spacer on mobile */
       }

      .calendar-body {
        overflow-x: auto;
      }
      .time-column {
        position: sticky;
        left: 0;
        z-index: 2;
        background-color: var(--surface); /* To prevent content from showing through */
      }
      .grid-container {
        /* Make the grid wide enough for 7 days without squishing */
        width: 175%; 
        min-width: 800px;
      }
       .day-name.today::after {
        bottom: -9px;
      }
    }


    /* Desktop */
    @media (min-width:901px){
      body{padding-bottom:0}
      .mobile-nav{display:none}
      .app{display:grid;grid-template-columns:var(--sidebar-w) minmax(0,1fr);gap:24px; height: 100vh;}
      .main { height: 100%; }

      .sidebar{display:flex;flex-direction:column;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px}
      .brand{display:flex;align-items:center;gap:12px;font-weight:700;font-size:22px;margin-bottom:18px}
      .brand .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#8B7CFF,#6AC9FF)}
      .nav{display:flex;flex-direction:column;gap:8px;overflow:auto;padding-right:2px}
      .nav a{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;color:var(--muted);text-decoration:none;font-weight:500;transition:.2s}
      .nav a i{font-size:20px}
      .nav a:hover{background:#F3F2FF;color:var(--primary)}
      .nav a.active{background:var(--primary);color:#fff;box-shadow:0 8px 20px rgba(111,108,255,.3)}
      .spacer{flex:1}
      .sidebar-footer{margin-top:auto;padding-top:16px;border-top:1px solid var(--border)}
      .sidebar-logout-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:12px;border-radius:12px;background:transparent;border:1px solid var(--border);color:var(--muted);font-weight:600;cursor:pointer;transition:.2s}
      .sidebar-logout-btn:hover{background:#fde2e2;border-color:#f7b2b2;color:#c82424}
      .sidebar-links{text-align:center;margin-top:16px;display:flex;justify-content:center;gap:16px}
      .sidebar-links a{font-size:12px;color:var(--muted);text-decoration:none}
      .sidebar-links a:hover{text-decoration:underline}
      .copyright{font-size:11px;color:#C0C3D2;text-align:center;margin-top:12px}

      .main-content{max-width:min(var(--content-max),calc(100vw - var(--sidebar-w) - 120px));margin:0 auto}

      .header{display:flex;justify-content:space-between;align-items:center; margin-top: 0; margin-bottom: 18px;}
      .header-top,.header-avatar-link,.header-actions{display:none}
      .header-main{display:block}
      .header-main h1{font-size:26px}
      .header-main p{font-size:15px;margin-top:6px}
      .header-toolbar{display:flex;align-items:center;gap:12px}
    }

    /* === Schedule Page Components === */
    .calendar-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border); border-radius: 16px;}
    .calendar-header { display: grid; grid-template-columns: 60px repeat(7, 1fr); text-align: center; font-weight: 600; color: var(--muted); padding: 12px 0; border-bottom: 1px solid var(--border); background: var(--bg); }
    .day-name.today { color: var(--primary); font-weight: 700; position: relative; }
    .day-name.today::after { content: ''; position: absolute; bottom: -13px; left: 50%; transform: translateX(-50%); width: 24px; height: 3px; background: var(--primary); border-radius: 3px; }

    .calendar-body { flex-grow: 1; overflow: auto; position: relative; display: flex; }
    .calendar-body { scrollbar-width: thin; scrollbar-color: var(--primary-2) transparent; }
    .calendar-body::-webkit-scrollbar { width: 6px; }
    .calendar-body::-webkit-scrollbar-track { background: transparent; }
    .calendar-body::-webkit-scrollbar-thumb { background-color: var(--primary-2); border-radius: 20px; }

    .time-column { flex-shrink: 0; width: 60px; }
    .time-label { height: var(--hour-height); text-align: right; padding-right: 12px; font-size: 12px; color: var(--muted); position: relative; }
    .time-label span { position: relative; top: -0.7em; }

    .grid-container { flex-grow: 1; display: grid; grid-template-columns: repeat(7, 1fr); position: relative; }
    .day-column { border-left: 1px solid var(--border); position: relative; background-image: linear-gradient(to bottom, var(--border) 1px, transparent 1px); background-size: 100% var(--hour-height); }
    .day-column:first-child { border-left: none; }

    .class-block {
        position: absolute;
        left: 6px;
        right: 6px;
        border-radius: 10px;
        padding: 8px 10px;
        overflow: hidden;
        transition: all 0.2s ease;
        text-decoration: none;
        border-left: 4px solid;
    }
    .class-block:hover { transform: translateY(-2px); box-shadow: var(--shadow); z-index: 5; }
    .class-block h3 { font-size: 14px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin:0 0 4px; }
    .class-block p { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin:0; }

    .current-time-indicator {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--danger);
        z-index: 10;
        display: none;
        pointer-events: none;
        transition: left .2s, width .2s;
    }
    .current-time-indicator::before {
        content: '';
        position: absolute;
        left: -5px;
        top: -4px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--danger);
    }
    .loader{ border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; margin: 60px auto; }
    @keyframes spin{ to{ transform: rotate(360deg) } }
    .empty{ text-align:center; padding:60px; border:2px dashed var(--border); border-radius:14px; background:var(--surface); color:var(--muted) }
    
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigasi utama">
      <div class="brand"><div class="logo" aria-hidden="true"></div>Academate</div>
      <nav class="nav">
        <a href="dashboard.html"><i class="ri-dashboard-2-line"></i><span>Dasbor</span></a>
        <a href="classes.html"><i class="ri-book-open-line"></i><span>Kelas</span></a>
        <a href="task.html"><i class="ri-task-line"></i><span>Tugas</span></a>
        <a class="active" href="schedule.html"><i class="ri-calendar-2-line"></i><span>Jadwal</span></a>
        <a href="notes.html"><i class="ri-file-list-3-line"></i><span>Catatan</span></a>
        <a href="account.html"><i class="ri-user-3-line"></i><span>Akun</span></a>
      </nav>
      <div class="spacer"></div>
      <div class="sidebar-footer">
        <button id="logout-button-desktop" class="sidebar-logout-btn" type="button" title="Keluar"><i class="ri-logout-box-r-line"></i><span>Keluar</span></button>
        <div class="sidebar-links"><a href="#">Terms of Service</a><a href="#">Privacy Policy</a></div>
        <p class="copyright">&copy; 2025 Academate</p>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="main-content">
        <header class="header">
          <div class="header-top">
            <div class="header-brand">Academate</div>
            <div class="header-actions">
              <button class="icon-btn" title="Cari"><i class="ri-search-line"></i></button>
              <button class="icon-btn" title="Notifikasi"><i class="ri-notification-3-line"></i></button>
            </div>
          </div>
          <div class="header-main">
            <div>
              <h1>Jadwal Mingguan</h1>
              <p>Semua jadwal kelas Anda dalam satu tampilan mingguan yang rapi.</p>
            </div>
            <a href="account.html" class="header-avatar-link"><img id="header-avatar-img" class="header-avatar" alt="Foto profil"></a>
          </div>
          <div class="header-toolbar">
            <!-- Toolbar content can go here if needed -->
          </div>
        </header>

        <div id="calendar-container" class="calendar-wrapper" aria-live="polite">
          <div class="loader" role="status" aria-label="Memuat jadwal..."></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Nav -->
  <nav class="mobile-nav">
    <a href="dashboard.html"><i class="ri-dashboard-2-line"></i><span>Dasbor</span></a>
    <a href="classes.html"><i class="ri-book-open-line"></i><span>Kelas</span></a>
    <a href="task.html"><i class="ri-task-line"></i><span>Tugas</span></a>
    <a class="active" href="schedule.html"><i class="ri-calendar-2-line"></i><span>Jadwal</span></a>
    <a href="notes.html"><i class="ri-file-list-3-line"></i><span>Catatan</span></a>
  </nav>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCGr2zchpiAiTn-bMFk-eLNE-1OgGzaSdA", authDomain: "acadmte.firebaseapp.com", projectId: "acadmte", storageBucket: "acadmte.appspot.com", messagingSenderId: "547286858993", appId: "1:547286858993:web:b83de49e7eb1cc35a67d50", measurementId: "G-ZEFYD7F650" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let timeIndicatorInterval = null;
    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        if (timeIndicatorInterval) clearInterval(timeIndicatorInterval);
        window.location.replace('auth.html');
        return;
      }
      currentUser = user;
      hydrateAvatar();
      loadScheduleData(user);
    });

    document.getElementById('logout-button-desktop')?.addEventListener('click', () => signOut(auth));

    function hydrateAvatar() {
      const avatar = document.getElementById('header-avatar-img');
      const name = localStorage.getItem('userDisplayName') || (currentUser?.displayName ?? 'A');
      const photo = localStorage.getItem('userPhotoURL') || currentUser?.photoURL;
      if (avatar) avatar.src = photo || `https://placehold.co/80x80/E5E7EB/6B7280?text=${(name||'A').charAt(0)}`;
    }

    async function loadScheduleData(user) {
      const calendarContainer = document.getElementById('calendar-container');
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const userDocSnap = await getDoc(userDocRef);
        const joinedClassesIds = userDocSnap.exists() ? userDocSnap.data().joinedClasses || [] : [];
        
        if (joinedClassesIds.length === 0) {
          renderEmptyCalendar();
          return;
        }
        
        const classPromises = joinedClassesIds.map(id => getDoc(doc(db, 'classes', id)));
        const classSnapshots = await Promise.all(classPromises);
        const classesData = classSnapshots
          .map(snap => ({ id: snap.id, ...snap.data() }))
          .filter(c => c.namaMataKuliah);
        
        renderCalendar(classesData);
      } catch (error) {
        console.error("Error loading schedule data:", error);
        calendarContainer.innerHTML = '<div class="empty">Gagal memuat jadwal. Silakan coba lagi.</div>';
      }
    }

    function renderCalendar(classes) {
      const calendarContainer = document.getElementById('calendar-container');
      calendarContainer.innerHTML = ''; 

      const classColors = [
          { bg: '#F3F2FF', border: '#8B5CF6' }, { bg: '#ECFDF5', border: '#10B981' },
          { bg: '#FFFBEB', border: '#F59E0B' }, { bg: '#FEF2F2', border: '#EF4444' },
          { bg: '#EFF6FF', border: '#3B82F6' }, { bg: '#FDF2F8', border: '#EC4899' }
      ];

      const header = document.createElement('div');
      header.className = 'calendar-header';
      header.innerHTML = `<div></div>`; // Spacer for desktop time column
      
      const body = document.createElement('div');
      body.className = 'calendar-body';
      
      const timeColumn = document.createElement('div');
      timeColumn.className = 'time-column';
      for (let hour = 7; hour <= 20; hour++) {
        timeColumn.innerHTML += `<div class="time-label"><span>${hour.toString().padStart(2, '0')}:00</span></div>`;
      }

      const gridContainer = document.createElement('div');
      gridContainer.className = 'grid-container';

      const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
      const dayFullNames = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
      const todayIndex = (new Date().getDay() + 6) % 7; // Monday is 0

      const dayElements = [];
      days.forEach((dayName, index) => {
        const dayHeader = document.createElement('div');
        dayHeader.className = `day-name ${index === todayIndex ? 'today' : ''}`;
        dayHeader.textContent = dayName;
        dayElements.push(dayHeader);

        const dayColumn = document.createElement('div');
        dayColumn.className = 'day-column';
        dayColumn.dataset.day = dayFullNames[index];
        gridContainer.appendChild(dayColumn);
      });
      
      // Conditionally wrap header elements for mobile scrolling
      if (window.innerWidth <= 900) {
        const headerScrollWrapper = document.createElement('div');
        headerScrollWrapper.className = 'header-scroll-wrapper';
        dayElements.forEach(el => headerScrollWrapper.appendChild(el));
        header.appendChild(headerScrollWrapper);
         // Sync scrolling between header and body
        body.addEventListener('scroll', () => {
            header.scrollLeft = body.scrollLeft;
        });
      } else {
        dayElements.forEach(el => header.appendChild(el));
      }


      body.append(timeColumn, gridContainer);
      calendarContainer.append(header, body);
      
      classes.forEach((c, index) => {
        const dayCol = gridContainer.querySelector(`[data-day="${c.hari}"]`);
        if (!dayCol || !c.waktu) return;

        const [startHour, startMinute] = c.waktu.split(':').map(Number);
        let durationMinutes = (c.sks || 2) * 50; // Default duration based on SKS

        if (c.waktuSelesai) {
          const [endHour, endMinute] = c.waktuSelesai.split(':').map(Number);
          durationMinutes = (endHour * 60 + endMinute) - (startHour * 60 + startMinute);
        }
        
        if (durationMinutes <= 0) return;

        const startOffsetMinutes = (startHour - 7) * 60 + startMinute;
        const hourHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--hour-height'));
        
        const top = (startOffsetMinutes / 60) * hourHeight;
        const height = (durationMinutes / 60) * hourHeight;
        
        const classBlock = document.createElement('a');
        classBlock.href = `class_page.html?id=${c.id}`;
        classBlock.className = 'class-block';
        classBlock.style.top = `${top}px`;
        classBlock.style.height = `${height}px`;

        const color = classColors[index % classColors.length];
        classBlock.style.backgroundColor = color.bg;
        classBlock.style.borderColor = color.border;
        
        const timeText = c.waktuSelesai ? `${c.waktu} - ${c.waktuSelesai}` : c.waktu;
        classBlock.innerHTML = `
            <h3>${escapeHTML(c.namaMataKuliah)}</h3>
            <p style="color: ${color.border}; font-weight: 500;">${timeText}</p>
            <p style="color: var(--muted);">Ruang ${escapeHTML(c.ruang)}</p>
        `;
        dayCol.appendChild(classBlock);
      });
      
      // Auto-scroll to today's column on mobile
      if (window.innerWidth <= 900) {
        const todayColumn = gridContainer.querySelectorAll('.day-column')[todayIndex];
        if (todayColumn) {
          // Center today's column if possible
          const scrollPos = todayColumn.offsetLeft - (body.clientWidth / 2) + (todayColumn.clientWidth / 2);
          body.scrollLeft = scrollPos;
        }
      }

      setupCurrentTimeIndicator();
      window.addEventListener('resize', setupCurrentTimeIndicator);
    }

    function setupCurrentTimeIndicator() {
      if (timeIndicatorInterval) clearInterval(timeIndicatorInterval);

      const gridContainer = document.querySelector('.calendar-body .grid-container');
      if (!gridContainer) return;

      let indicator = document.querySelector('.current-time-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.className = 'current-time-indicator';
        gridContainer.appendChild(indicator);
      }
      
      const updatePosition = () => {
        const now = new Date();
        const todayDayIndex = (now.getDay() + 6) % 7;
        const dayColumns = gridContainer.querySelectorAll('.day-column');
        
        if (todayDayIndex >= dayColumns.length) {
          indicator.style.display = 'none';
          return;
        }

        const currentMinutes = (now.getHours() - 7) * 60 + now.getMinutes();
        if (currentMinutes < 0 || currentMinutes > 14 * 60) {
             indicator.style.display = 'none';
             return;
        }

        const hourHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--hour-height'));
        indicator.style.display = 'block';
        indicator.style.top = `${(currentMinutes / 60) * hourHeight}px`;
        indicator.style.left = `${dayColumns[todayDayIndex].offsetLeft}px`;
        indicator.style.width = `${dayColumns[todayDayIndex].offsetWidth}px`;
      };
      
      updatePosition();
      const initialTop = parseFloat(indicator.style.top);
      if (!isNaN(initialTop) && document.querySelector('.calendar-body').scrollTop === 0) {
        const calendarBody = document.querySelector('.calendar-body');
        const viewportHeight = calendarBody.clientHeight;
        calendarBody.scrollTop = initialTop - (viewportHeight / 3);
      }

      timeIndicatorInterval = setInterval(updatePosition, 60000);
    }
    
    function renderEmptyCalendar() {
      document.getElementById('calendar-container').innerHTML = `<div class="empty">
        <h3 style="margin: 0 0 8px;">Jadwal Anda masih kosong</h3>
        <p style="margin:0;">Bergabunglah dengan sebuah kelas untuk melihat jadwal Anda di sini.</p>
      </div>`;
    }

    function escapeHTML(s) {
      return (s || '').replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
    }
  </script>
</body>
</html>

